<!DOCTYPE html>
<html lang="zh-CN">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>GhostLink - Manual Mint Tool</title>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
      <style>
        body {
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              max-width: 900px;
              margin: 0 auto;
              padding: 20px;
              background-color: #f5f5f5;
            }
        .container {
              background: white;
              padding: 30px;
              border-radius: 12px;
              box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
        h1 {
              color: #333;
              border-bottom: 3px solid #000;
              padding-bottom: 10px;
            }
        h2 {
              color: #555;
              margin-top: 30px;
              font-size: 1.2em;
            }
        .section {
              margin-bottom: 25px;
              padding: 20px;
              background: #fafafa;
              border-radius: 8px;
              border-left: 4px solid #000;
            }
        label {
              display: block;
              margin-top: 15px;
              margin-bottom: 5px;
              font-weight: bold;
              color: #333;
            }
        input[type="text"], textarea {
              width: 100%;
              padding: 10px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              border: 2px solid #ddd;
              border-radius: 4px;
              box-sizing: border-box;
            }
        input[type="text"]:focus, textarea:focus {
              border-color: #000;
              outline: none;
            }
        textarea {
              min-height: 100px;
              resize: vertical;
            }
        button {
              padding: 12px 24px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              background-color: #000;
              color: white;
              border: none;
              border-radius: 6px;
              margin-top: 15px;
              margin-right: 10px;
              transition: background-color 0.3s;
            }
        button:hover:not(:disabled) {
              background-color: #333;
            }
        button:disabled {
              background-color: #ccc;
              cursor: not-allowed;
            }
        .btn-secondary {
              background-color: #666;
            }
        .btn-secondary:hover:not(:disabled) {
              background-color: #888;
            }
        #status {
              margin-top: 20px;
              padding: 15px;
              border-radius: 6px;
              font-weight: bold;
            }
        .status-success {
              background-color: #d4edda;
              color: #155724;
              border: 1px solid #c3e6cb;
            }
        .status-error {
              background-color: #f8d7da;
              color: #721c24;
              border: 1px solid #f5c6cb;
            }
        .status-info {
              background-color: #d1ecf1;
              color: #0c5460;
              border: 1px solid #bee5eb;
            }
        .status-warning {
              background-color: #fff3cd;
              color: #856404;
              border: 1px solid #ffeaa7;
            }
        pre {
              background: #f4f4f4;
              padding: 15px;
              border-radius: 6px;
              overflow-x: auto;
              border: 1px solid #ddd;
              font-size: 12px;
            }
        .info-box {
              background: #e8f4f8;
              padding: 15px;
              border-radius: 6px;
              margin-top: 15px;
              border-left: 4px solid #2196F3;
            }
        .info-box strong {
              color: #1976D2;
            }
        .param-hint {
              font-size: 12px;
              color: #666;
              margin-top: 5px;
              font-style: italic;
            }
        .wallet-info {
              display: inline-block;
              padding: 8px 15px;
              background: #e8f5e9;
              border-radius: 4px;
              margin-left: 10px;
              color: #2e7d32;
              font-weight: bold;
            }
        .validation-error {
              color: #d32f2f;
              font-size: 12px;
              margin-top: 5px;
            }
      </style>
</head>
<body>
  <div class="container">
        <h1>ğŸ”— GhostLink - Manual Mint Tool</h1>
        <p style="color: #666;">æ‰‹åŠ¨è¾“å…¥åˆçº¦åœ°å€å’Œå‚æ•°æ¥è°ƒç”¨ mint æ–¹æ³•</p>

        <!-- Wallet Connection -->
        <div class="section">
          <h2>1. è¿æ¥é’±åŒ…</h2>
          <button id="connectBtn">è¿æ¥ MetaMask</button>
          <span id="walletAddress" class="wallet-info" style="display: none;">æœªè¿æ¥</span>
        </div>

        <!-- Contract Address -->
        <div class="section">
          <h2>2. åˆçº¦åœ°å€</h2>
          <label for="contractAddress">åˆçº¦åœ°å€ (Contract Address):</label>
          <input type="text" id="contractAddress" placeholder="0x..." />
          <div class="param-hint">å·²éƒ¨ç½²çš„ GhostLinkSBT åˆçº¦åœ°å€</div>
          <button id="loadContractInfoBtn" class="btn-secondary" disabled>åŠ è½½åˆçº¦ä¿¡æ¯</button>
          <div id="contractInfo" style="margin-top: 15px;"></div>
        </div>

        <!-- Mint Parameters -->
        <div class="section">
          <h2>3. Mint å‚æ•°</h2>
         
          <label for="sealInput">Seal (bytes):</label>
          <textarea id="sealInput" placeholder="0x22d5a59a... (å®Œæ•´çš„ seal åå…­è¿›åˆ¶å­—ç¬¦ä¸²)"></textarea>
          <div class="param-hint">
            æ ¼å¼ï¼š0x å¼€å¤´çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²<br>
            é•¿åº¦ï¼šé€šå¸¸çº¦ 512-600 ä¸ªå­—ç¬¦ï¼ˆ256-300 å­—èŠ‚ï¼‰<br>
            æ¥æºï¼šåç«¯ /prove æ¥å£è¿”å›çš„ receipt_hex å­—æ®µ
          </div>
          <div id="sealError" class="validation-error"></div>

          <label for="recipientInput">Recipient (address):</label>
          <input type="text" id="recipientInput" placeholder="0x..." />
          <div class="param-hint">
            æ ¼å¼ï¼š0x å¼€å¤´çš„ä»¥å¤ªåŠåœ°å€ï¼ˆ42 ä¸ªå­—ç¬¦ï¼‰<br>
            æ³¨æ„ï¼šå¿…é¡»æ˜¯å½“å‰è¿æ¥çš„é’±åŒ…åœ°å€
          </div>
          <button id="useWalletAddressBtn" class="btn-secondary" disabled>ä½¿ç”¨å½“å‰é’±åŒ…åœ°å€</button>
          <div id="recipientError" class="validation-error"></div>

          <label for="nullifierInput">Nullifier (bytes32):</label>
          <input type="text" id="nullifierInput" placeholder="0x..." />
          <div class="param-hint">
            æ ¼å¼ï¼š0x å¼€å¤´çš„ 64 ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼ˆ66 ä¸ªå­—ç¬¦ï¼ŒåŒ…å« 0xï¼‰<br>
            æ¥æºï¼šåç«¯ /prove æ¥å£è¿”å›çš„ nullifier_hex å­—æ®µï¼ˆéœ€è¦æ·»åŠ  0x å‰ç¼€ï¼‰
          </div>
          <div id="nullifierError" class="validation-error"></div>
        </div>

        <!-- Actions -->
        <div class="section">
          <h2>4. æ‰§è¡Œæ“ä½œ</h2>
          <button id="validateBtn" class="btn-secondary">éªŒè¯å‚æ•°</button>
          <button id="checkNullifierBtn" class="btn-secondary" disabled>æ£€æŸ¥ Nullifier æ˜¯å¦å·²ä½¿ç”¨</button>
          <button id="mintBtn" disabled>ğŸš€ Mint SBT</button>
          <div id="status"></div>
        </div>

        <!-- Results -->
        <div class="section" id="resultsSection" style="display: none;">
          <h2>5. äº¤æ˜“ç»“æœ</h2>
          <pre id="resultOutput"></pre>
        </div>

        <!-- Query Functions -->
        <div class="section">
          <h2>6. æŸ¥è¯¢åŠŸèƒ½</h2>
          <button id="checkMySBTsBtn" class="btn-secondary" disabled>æŸ¥è¯¢æˆ‘çš„ SBT</button>
          <button id="queryTokenBtn" class="btn-secondary" disabled>æŸ¥è¯¢ Token ä¿¡æ¯</button>
          <input type="text" id="tokenIdInput" placeholder="Token ID" style="width: 200px; margin-left: 10px;" />
          <div id="queryResults" style="margin-top: 15px;"></div>
        </div>
      </div>

  <script>
    let provider, signer, userAddress;
    const contractABI = [
        "function mint(bytes calldata seal, address recipient, bytes32 nullifier) external",
        "function imageId() external view returns (bytes32)",
        "function verifier() external view returns (address)",
        "function nullifiers(bytes32) external view returns (bool)",
        "function name() external view returns (string)",
        "function symbol() external view returns (string)",
        "function totalSupply() external view returns (uint256)",
        "function balanceOf(address owner) external view returns (uint256)",
        "function tokenOfOwnerByIndex(address owner, uint256 index) external view returns (uint256)",
        "function ownerOf(uint256 tokenId) external view returns (address)",
        "event Minted(address indexed recipient, uint256 indexed tokenId, bytes32 nullifier)"
    ];

    // åˆå§‹åŒ–
    window.addEventListener('load', async () => {
        if (typeof window.ethereum !== 'undefined') {
            provider = new ethers.BrowserProvider(window.ethereum);
            await checkConnection();
        } else {
            showStatus('è¯·å®‰è£… MetaMask é’±åŒ…æ‰©å±•', 'error');
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('connectBtn').addEventListener('click', connectWallet);
        document.getElementById('useWalletAddressBtn').addEventListener('click', useWalletAddress);
        document.getElementById('contractAddress').addEventListener('input', updateButtons);
        document.getElementById('sealInput').addEventListener('input', validateSeal);
        document.getElementById('recipientInput').addEventListener('input', validateRecipient);
        document.getElementById('nullifierInput').addEventListener('input', validateNullifier);
        document.getElementById('validateBtn').addEventListener('click', validateAllParams);
        document.getElementById('checkNullifierBtn').addEventListener('click', checkNullifier);
        document.getElementById('loadContractInfoBtn').addEventListener('click', loadContractInfo);
        document.getElementById('mintBtn').addEventListener('click', mintSBT);
        document.getElementById('checkMySBTsBtn').addEventListener('click', checkMySBTs);
        document.getElementById('queryTokenBtn').addEventListener('click', queryTokenInfo);
    });

    async function checkConnection() {
        try {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
                await connectWallet();
            }
        } catch (e) {
            console.error('Check connection error:', e);
        }
    }

    async function connectWallet() {
        try {
            if (!window.ethereum) {
                showStatus('è¯·å®‰è£… MetaMask é’±åŒ…', 'error');
                return;
            }

            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            userAddress = ethers.getAddress(userAddress); // æ ‡å‡†åŒ–åœ°å€

            document.getElementById('walletAddress').textContent = `å·²è¿æ¥: ${userAddress}`;
            document.getElementById('walletAddress').style.display = 'inline-block';
            document.getElementById('connectBtn').textContent = 'å·²è¿æ¥';
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('useWalletAddressBtn').disabled = false;
            document.getElementById('checkMySBTsBtn').disabled = false;

            updateButtons();
            showStatus('é’±åŒ…è¿æ¥æˆåŠŸ', 'success');
        } catch (e) {
            showStatus('è¿æ¥é’±åŒ…å¤±è´¥: ' + e.message, 'error');
        }
    }

    function useWalletAddress() {
        if (userAddress) {
            document.getElementById('recipientInput').value = userAddress;
            validateRecipient();
        }
    }

    function updateButtons() {
        const contractAddr = document.getElementById('contractAddress').value.trim();
        const hasContract = contractAddr && ethers.isAddress(contractAddr);
        document.getElementById('loadContractInfoBtn').disabled = !hasContract;
        document.getElementById('checkNullifierBtn').disabled = !hasContract || !signer;
        document.getElementById('checkMySBTsBtn').disabled = !hasContract || !signer;
        document.getElementById('queryTokenBtn').disabled = !hasContract || !signer;
        updateMintButton();
    }

    function updateMintButton() {
        const seal = document.getElementById('sealInput').value.trim();
        const recipient = document.getElementById('recipientInput').value.trim();
        const nullifier = document.getElementById('nullifierInput').value.trim();
        const contractAddr = document.getElementById('contractAddress').value.trim();

        const canMint = seal && recipient && nullifier && contractAddr && signer &&
            seal.startsWith('0x') && ethers.isAddress(recipient) &&
            nullifier.startsWith('0x') && nullifier.length === 66 &&
            ethers.isAddress(contractAddr);

        document.getElementById('mintBtn').disabled = !canMint;
    }

    function validateSeal() {
        const seal = document.getElementById('sealInput').value.trim();
        const errorDiv = document.getElementById('sealError');

        if (!seal) {
            errorDiv.textContent = '';
            updateMintButton();
            return;
        }

        if (!seal.startsWith('0x')) {
            errorDiv.textContent = 'âŒ Seal å¿…é¡»ä»¥ 0x å¼€å¤´';
            updateMintButton();
            return;
        }

        const hexPart = seal.substring(2);
        if (!/^[0-9a-fA-F]+$/.test(hexPart)) {
            errorDiv.textContent = 'âŒ Seal åŒ…å«æ— æ•ˆçš„åå…­è¿›åˆ¶å­—ç¬¦';
            updateMintButton();
            return;
        }

        const byteLength = hexPart.length / 2;
        if (byteLength < 200 || byteLength > 400) {
            errorDiv.textContent = `âš ï¸ Seal é•¿åº¦å¼‚å¸¸ (${byteLength} å­—èŠ‚)ï¼Œé€šå¸¸åº”ä¸º 256-300 å­—èŠ‚`;
        } else {
            errorDiv.textContent = `âœ… Seal æ ¼å¼æ­£ç¡® (${byteLength} å­—èŠ‚)`;
        }

        updateMintButton();
    }

    function validateRecipient() {
        const recipient = document.getElementById('recipientInput').value.trim();
        const errorDiv = document.getElementById('recipientError');

        if (!recipient) {
            errorDiv.textContent = '';
            updateMintButton();
            return;
        }

        if (!ethers.isAddress(recipient)) {
            errorDiv.textContent = 'âŒ æ— æ•ˆçš„ä»¥å¤ªåŠåœ°å€';
            updateMintButton();
            return;
        }

        if (userAddress && recipient.toLowerCase() !== userAddress.toLowerCase()) {
            errorDiv.textContent = 'âš ï¸ è­¦å‘Šï¼šRecipient å¿…é¡»ä¸å½“å‰è¿æ¥çš„é’±åŒ…åœ°å€ä¸€è‡´';
        } else {
            errorDiv.textContent = 'âœ… åœ°å€æ ¼å¼æ­£ç¡®';
        }

        updateMintButton();
    }

    function validateNullifier() {
        const nullifier = document.getElementById('nullifierInput').value.trim();
        const errorDiv = document.getElementById('nullifierError');

        if (!nullifier) {
            errorDiv.textContent = '';
            updateMintButton();
            return;
        }

        if (!nullifier.startsWith('0x')) {
            errorDiv.textContent = 'âŒ Nullifier å¿…é¡»ä»¥ 0x å¼€å¤´';
            updateMintButton();
            return;
        }

        if (nullifier.length !== 66) {
            errorDiv.textContent = `âŒ Nullifier é•¿åº¦é”™è¯¯ (${nullifier.length} å­—ç¬¦)ï¼Œåº”ä¸º 66 å­—ç¬¦ (0x + 64 hex)`;
            updateMintButton();
            return;
        }

        const hexPart = nullifier.substring(2);
        if (!/^[0-9a-fA-F]{64}$/.test(hexPart)) {
            errorDiv.textContent = 'âŒ Nullifier å¿…é¡»åŒ…å« 64 ä¸ªæœ‰æ•ˆçš„åå…­è¿›åˆ¶å­—ç¬¦';
            updateMintButton();
            return;
        }

        errorDiv.textContent = 'âœ… Nullifier æ ¼å¼æ­£ç¡®';
        updateMintButton();
    }

    async function validateAllParams() {
        const seal = document.getElementById('sealInput').value.trim();
        const recipient = document.getElementById('recipientInput').value.trim();
        const nullifier = document.getElementById('nullifierInput').value.trim();
        const contractAddr = document.getElementById('contractAddress').value.trim();

        const errors = [];

        if (!contractAddr || !ethers.isAddress(contractAddr)) {
            errors.push('åˆçº¦åœ°å€æ— æ•ˆ');
        }

        if (!seal || !seal.startsWith('0x')) {
            errors.push('Seal æ ¼å¼æ— æ•ˆ');
        }

        if (!recipient || !ethers.isAddress(recipient)) {
            errors.push('Recipient åœ°å€æ— æ•ˆï¼ˆè¯·æ£€æŸ¥åœ°å€æ ¼å¼ï¼Œå¿…é¡»ä»¥ 0x å¼€å¤´ï¼Œé•¿åº¦ä¸º 42 å­—ç¬¦ï¼‰');
        } else {
            // åªæœ‰åœ¨åœ°å€æ ¼å¼æœ‰æ•ˆæ—¶ï¼Œæ‰æ£€æŸ¥æ˜¯å¦ä¸é’±åŒ…åœ°å€ä¸€è‡´
            if (userAddress && recipient.toLowerCase() !== userAddress.toLowerCase()) {
                errors.push('Recipient å¿…é¡»ä¸å½“å‰è¿æ¥çš„é’±åŒ…åœ°å€ä¸€è‡´ï¼ˆè¯·ç‚¹å‡»"ä½¿ç”¨å½“å‰é’±åŒ…åœ°å€"æŒ‰é’®ï¼‰');
            }
        }

        if (!nullifier || nullifier.length !== 66) {
            errors.push('Nullifier æ ¼å¼æ— æ•ˆï¼ˆå¿…é¡»ä»¥ 0x å¼€å¤´ï¼Œé•¿åº¦ä¸º 66 å­—ç¬¦ï¼‰');
        }

        if (errors.length > 0) {
            showStatus('âŒ éªŒè¯å¤±è´¥:\n' + errors.join('\n'), 'error');
            return;
        }

        // å°è¯•è¿æ¥åˆçº¦å¹¶éªŒè¯ Image IDï¼ˆå¦‚æœå¯èƒ½ï¼‰
        try {
            const contract = new ethers.Contract(contractAddr, contractABI, provider);
            const imageId = await contract.imageId();
            showStatus(`âœ… å‚æ•°éªŒè¯é€šè¿‡\nåˆçº¦ Image ID: ${imageId}`, 'success');
        } catch (e) {
            showStatus('âœ… åŸºæœ¬å‚æ•°éªŒè¯é€šè¿‡\nâš ï¸ æ— æ³•éªŒè¯åˆçº¦ Image ID: ' + e.message, 'warning');
        }
    }

    async function checkNullifier() {
        const contractAddr = document.getElementById('contractAddress').value.trim();
        const nullifier = document.getElementById('nullifierInput').value.trim();

        if (!contractAddr || !ethers.isAddress(contractAddr)) {
            showStatus('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„åˆçº¦åœ°å€', 'error');
            return;
        }

        if (!nullifier || nullifier.length !== 66) {
            showStatus('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„ Nullifier', 'error');
            return;
        }

        try {
            const contract = new ethers.Contract(contractAddr, contractABI, provider);
            const used = await contract.nullifiers(nullifier);

            if (used) {
                showStatus('âŒ è¯¥ Nullifier å·²è¢«ä½¿ç”¨ï¼Œæ— æ³•å†æ¬¡ mint', 'error');
            } else {
                showStatus('âœ… è¯¥ Nullifier æœªè¢«ä½¿ç”¨ï¼Œå¯ä»¥ mint', 'success');
            }
        } catch (e) {
            showStatus('æ£€æŸ¥ Nullifier å¤±è´¥: ' + e.message, 'error');
        }
    }

    async function loadContractInfo() {
        const contractAddr = document.getElementById('contractAddress').value.trim();

        if (!contractAddr || !ethers.isAddress(contractAddr)) {
            showStatus('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„åˆçº¦åœ°å€', 'error');
            return;
        }

        try {
            const contract = new ethers.Contract(contractAddr, contractABI, provider);
            const [name, symbol, imageId, verifier] = await Promise.all([
                contract.name(),
                contract.symbol(),
                contract.imageId(),
                contract.verifier()
            ]);

            const infoDiv = document.getElementById('contractInfo');
            infoDiv.innerHTML = `
          <div class="info-box">
            <strong>åˆçº¦ä¿¡æ¯ï¼š</strong><br>
            åç§°: ${name}<br>
            ç¬¦å·: ${symbol}<br>
            Image ID: ${imageId}<br>
            Verifier: ${verifier}
          </div>
        `;
            showStatus('åˆçº¦ä¿¡æ¯åŠ è½½æˆåŠŸ', 'success');
        } catch (e) {
            showStatus('åŠ è½½åˆçº¦ä¿¡æ¯å¤±è´¥: ' + e.message, 'error');
        }
    }

    async function mintSBT() {
        const contractAddr = document.getElementById('contractAddress').value.trim();
        let seal = document.getElementById('sealInput').value.trim();
        let recipient = document.getElementById('recipientInput').value.trim();
        let nullifier = document.getElementById('nullifierInput').value.trim();

        // éªŒè¯åŸºæœ¬å‚æ•°
        if (!contractAddr || !ethers.isAddress(contractAddr)) {
            showStatus('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„åˆçº¦åœ°å€', 'error');
            return;
        }

        if (!seal || !seal.startsWith('0x')) {
            showStatus('Seal æ ¼å¼æ— æ•ˆ', 'error');
            return;
        }

        if (!recipient || !ethers.isAddress(recipient)) {
            showStatus('Recipient åœ°å€æ— æ•ˆ', 'error');
            return;
        }

        recipient = ethers.getAddress(recipient); // æ ‡å‡†åŒ–åœ°å€

        if (!nullifier || nullifier.length !== 66) {
            showStatus('Nullifier æ ¼å¼æ— æ•ˆ', 'error');
            return;
        }

        if (!signer) {
            showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
            return;
        }

        // éªŒè¯ recipient å¿…é¡»æ˜¯å½“å‰é’±åŒ…åœ°å€
        const currentAddress = await signer.getAddress();
        if (recipient.toLowerCase() !== currentAddress.toLowerCase()) {
            showStatus('âŒ Recipient å¿…é¡»ä¸å½“å‰è¿æ¥çš„é’±åŒ…åœ°å€ä¸€è‡´', 'error');
            return;
        }

        try {
            const contract = new ethers.Contract(contractAddr, contractABI, signer);

            // é¢„æ£€æŸ¥ï¼šéªŒè¯ Image IDï¼ˆå¯é€‰ï¼Œä½†å»ºè®®ï¼‰
            showStatus('æ­£åœ¨éªŒè¯åˆçº¦å‚æ•°...', 'info');
            const contractImageId = await contract.imageId();
            console.log('Contract Image ID:', contractImageId);

            // é¢„æ£€æŸ¥ï¼šæ£€æŸ¥ nullifier æ˜¯å¦å·²ä½¿ç”¨
            showStatus('æ­£åœ¨æ£€æŸ¥ Nullifier...', 'info');
            const nullifierUsed = await contract.nullifiers(nullifier);
            if (nullifierUsed) {
                throw new Error('è¯¥è¯æ˜å·²è¢«ä½¿ç”¨ï¼Œæ— æ³•å†æ¬¡ mint');
            }

            // æ¨¡æ‹Ÿäº¤æ˜“ä»¥è·å–è¯¦ç»†é”™è¯¯
            showStatus('æ­£åœ¨æ¨¡æ‹Ÿäº¤æ˜“...', 'info');
            try {
                await contract.mint.staticCall(seal, recipient, nullifier);
                console.log('âœ… Transaction simulation passed');
            } catch (simError) {
                console.error('Transaction simulation failed:', simError);
                const errorMsg = simError.reason || simError.message || 'äº¤æ˜“æ¨¡æ‹Ÿå¤±è´¥';
                throw new Error(`äº¤æ˜“å°†å¤±è´¥: ${errorMsg}`);
            }

            // ä¼°ç®— Gas
            showStatus('æ­£åœ¨ä¼°ç®— Gas...', 'info');
            let gasEstimate;
            try {
                gasEstimate = await contract.mint.estimateGas(seal, recipient, nullifier);
                console.log('Gas estimate:', gasEstimate.toString());
            } catch (gasError) {
                console.error('Gas estimation failed:', gasError);
                throw new Error('Gas ä¼°ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‚æ•°æ˜¯å¦æ­£ç¡®');
            }

            // å‘é€äº¤æ˜“
            showStatus('æ­£åœ¨å‘é€äº¤æ˜“...', 'info');
            const tx = await contract.mint(seal, recipient, nullifier, {
                gasLimit: gasEstimate * BigInt(2) // ä½¿ç”¨ 2 å€çš„ gas ä¼°ç®—å€¼
            });

            showStatus(`äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤...\näº¤æ˜“å“ˆå¸Œ: ${tx.hash}`, 'info');
            console.log('Transaction hash:', tx.hash);

            // ç­‰å¾…äº¤æ˜“ç¡®è®¤
            const receipt = await tx.wait();
            console.log('Transaction receipt:', receipt);

            // è§£æäº‹ä»¶
            let tokenId = null;
            if (receipt.logs) {
                const iface = new ethers.Interface(contractABI);
                for (const log of receipt.logs) {
                    try {
                        const parsed = iface.parseLog(log);
                        if (parsed && parsed.name === 'Minted') {
                            tokenId = parsed.args.tokenId.toString();
                            console.log('Minted token ID:', tokenId);
                        }
                    } catch (e) {
                        // å¿½ç•¥æ— æ³•è§£æçš„æ—¥å¿—
                    }
                }
            }

            // æ˜¾ç¤ºç»“æœ
            const resultDiv = document.getElementById('resultsSection');
            const resultOutput = document.getElementById('resultOutput');
            resultDiv.style.display = 'block';
            resultOutput.textContent = JSON.stringify({
                success: true,
                transactionHash: receipt.hash,
                blockNumber: receipt.blockNumber,
                gasUsed: receipt.gasUsed.toString(),
                tokenId: tokenId || 'N/A',
                recipient: recipient,
                nullifier: nullifier
            }, null, 2);

            showStatus(`âœ… Mint æˆåŠŸï¼\nToken ID: ${tokenId || 'N/A'}\näº¤æ˜“å“ˆå¸Œ: ${receipt.hash}`, 'success');

        } catch (e) {
            console.error('Mint error:', e);
            let errorMsg = e.message || 'æœªçŸ¥é”™è¯¯';

            // è§£æå¸¸è§é”™è¯¯
            if (errorMsg.includes('Image ID mismatch')) {
                errorMsg = 'Image ID ä¸åŒ¹é…ï¼Œè¯·ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„è¯æ˜';
            } else if (errorMsg.includes('already been used')) {
                errorMsg = 'è¯¥è¯æ˜å·²è¢«ä½¿ç”¨ï¼Œæ— æ³•å†æ¬¡ mint';
            } else if (errorMsg.includes('Proof must be for')) {
                errorMsg = 'Recipient å¿…é¡»ä¸äº¤æ˜“å‘é€è€…ä¸€è‡´';
            } else if (errorMsg.includes('execution reverted')) {
                errorMsg = 'äº¤æ˜“æ‰§è¡Œå¤±è´¥ï¼Œå¯èƒ½æ˜¯è¯æ˜éªŒè¯å¤±è´¥æˆ–å‚æ•°é”™è¯¯';
            }

            showStatus('âŒ Mint å¤±è´¥: ' + errorMsg, 'error');

            const resultDiv = document.getElementById('resultsSection');
            const resultOutput = document.getElementById('resultOutput');
            resultDiv.style.display = 'block';
            resultOutput.textContent = JSON.stringify({
                success: false,
                error: errorMsg,
                details: e.toString()
            }, null, 2);
        }
    }

    async function checkMySBTs() {
        const contractAddr = document.getElementById('contractAddress').value.trim();

        if (!contractAddr || !ethers.isAddress(contractAddr)) {
            showStatus('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„åˆçº¦åœ°å€', 'error');
            return;
        }

        if (!signer) {
            showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
            return;
        }

        try {
            const contract = new ethers.Contract(contractAddr, contractABI, provider);
            const balance = await contract.balanceOf(userAddress);

            const resultsDiv = document.getElementById('queryResults');
            if (balance === 0n) {
                resultsDiv.innerHTML = '<div class="info-box">æ‚¨å½“å‰æ²¡æœ‰æŒæœ‰ä»»ä½• SBT</div>';
                return;
            }

            // æ³¨æ„ï¼šæ ‡å‡† ERC721 æ²¡æœ‰ tokenOfOwnerByIndexï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
            // å®é™…å®ç°å¯èƒ½éœ€è¦éå†æˆ–ä½¿ç”¨å…¶ä»–æ–¹æ³•
            resultsDiv.innerHTML = `
          <div class="info-box">
            <strong>æ‚¨çš„ SBT æ•°é‡ï¼š</strong> ${balance.toString()}<br>
            <small>æ³¨æ„ï¼šæ­¤åˆçº¦ä¸ºæ ‡å‡† ERC721ï¼Œå¦‚éœ€æŸ¥è¯¢å…·ä½“ Token IDï¼Œè¯·ä½¿ç”¨ "æŸ¥è¯¢ Token ä¿¡æ¯" åŠŸèƒ½</small>
          </div>
        `;
        } catch (e) {
            showStatus('æŸ¥è¯¢å¤±è´¥: ' + e.message, 'error');
        }
    }

    async function queryTokenInfo() {
        const contractAddr = document.getElementById('contractAddress').value.trim();
        const tokenId = document.getElementById('tokenIdInput').value.trim();

        if (!contractAddr || !ethers.isAddress(contractAddr)) {
            showStatus('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„åˆçº¦åœ°å€', 'error');
            return;
        }

        if (!tokenId || isNaN(tokenId)) {
            showStatus('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„ Token ID', 'error');
            return;
        }

        try {
            const contract = new ethers.Contract(contractAddr, contractABI, provider);
            const owner = await contract.ownerOf(tokenId);

            const resultsDiv = document.getElementById('queryResults');
            resultsDiv.innerHTML = `
          <div class="info-box">
            <strong>Token #${tokenId} ä¿¡æ¯ï¼š</strong><br>
            æ‰€æœ‰è€…: ${owner}<br>
            ${owner.toLowerCase() === userAddress?.toLowerCase() ? 'âœ… è¿™æ˜¯æ‚¨çš„ Token' : ''}
          </div>
        `;
        } catch (e) {
            showStatus('æŸ¥è¯¢å¤±è´¥: ' + e.message, 'error');
        }
    }

    function showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = 'status-' + type;
        statusDiv.style.display = 'block';
    }
</script>
</body>
</html>

