<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostLink | Invisible Tech, Visible Trust</title>

    <!-- Fonts: Inter (Variable) & SF Pro Display simulation -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Ethers.js for Ethereum interaction -->
    <!-- 使用多个CDN源以确保加载成功 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"
        onerror="console.error('Failed to load ethers.js from jsdelivr'); this.onerror=null; this.src='https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';">
        </script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: {
                            DEFAULT: '#F5F5F7', // Off-white
                            surface: '#FFFFFF', // Ceramic White
                        },
                        text: {
                            DEFAULT: '#111111', // Ink Black
                            muted: '#6B7280',   // Cool Grey
                        },
                        accent: {
                            DEFAULT: '#3B82F6', // Holographic Blue
                            dark: '#2563EB',
                        },
                        border: {
                            DEFAULT: '#E5E7EB',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'glass': '0 4px 30px rgba(0, 0, 0, 0.05)',
                        'prism': '0 20px 40px -10px rgba(59, 130, 246, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F5F5F7;
            color: #111111;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Optical Glass Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        /* Prism Gradient */
        .prism-gradient {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(59, 130, 246, 0.1) 50%, rgba(255, 255, 255, 0.4) 100%);
        }

        /* Rainbow sheen for hologram */
        .hologram-text {
            background: linear-gradient(90deg, #111 0%, #3B82F6 50%, #111 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 5s linear infinite;
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // 检查必要的库是否已加载
        if (typeof React === 'undefined') {
            console.error('React is not loaded');
            document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>加载错误</h1><p>React 库未加载，请刷新页面重试</p></div>';
        }

        if (typeof ethers === 'undefined') {
            console.warn('ethers.js is not loaded yet. Some features may not work.');
            // 不阻止页面加载，但会在使用时检查
        }

        const { useState, useEffect } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- CONFIGURATION ---
        const GITHUB_CLIENT_ID = "Iv23li88rvwnNxTsjlfc";
        const TWITTER_CLIENT_ID = "Y2ZMMWgzOGNNYjdISDhVZ1BHNjc6MTpjaQ";

        // The redirect URI must match what you configured in GitHub App settings
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        // Contract Configuration
        const CONTRACT_ADDRESS = "0x79983eA479BfeD6d597A0e7420E13ae7Ac0c0445";
        // 测试网RPC (Sepolia测试网示例，根据实际部署的网络修改)
        const RPC_URL = "https://sepolia.infura.io/v3/YOUR_INFURA_KEY"; // 或使用公共RPC
        const CHAIN_ID = 11155111; // Sepolia测试网，根据实际网络修改

        // 合约ABI (根据调用指导.md文档，使用 mint 接口)
        // 参考调用指导.md：mint(bytes calldata seal, address recipient, bytes32 nullifier)
        const CONTRACT_ABI = [
            "function mint(bytes calldata seal, address recipient, bytes32 nullifier) external",
            "function imageId() external view returns (bytes32)",
            "function verifier() external view returns (address)",
            "function nullifiers(bytes32) external view returns (bool)",
            "function name() external view returns (string)",
            "function symbol() external view returns (string)",
            "function totalSupply() external view returns (uint256)",
            "function balanceOf(address owner) external view returns (uint256)",
            "function ownerOf(uint256 tokenId) external view returns (address)",
            "event Minted(address indexed recipient, uint256 indexed tokenId, bytes32 nullifier)"
        ];

        // --- Helper: 等待 ethers.js 加载 ---
        const waitForEthers = () => {
            return new Promise((resolve, reject) => {
                if (typeof ethers !== 'undefined') {
                    resolve(ethers);
                    return;
                }

                // 等待最多5秒
                let attempts = 0;
                const maxAttempts = 50; // 5秒 = 50 * 100ms
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof ethers !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(ethers);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('ethers.js 加载超时，请刷新页面重试'));
                    }
                }, 100);
            });
        };

        // --- Helper: 等待钱包提供者加载 ---
        const waitForWalletProvider = () => {
            return new Promise((resolve, reject) => {
                // 立即检查一次
                const checkProvider = () => {
                    // 检查 window.ethereum
                    if (window.ethereum) {
                        console.log('Wallet provider found:', {
                            isMetaMask: window.ethereum.isMetaMask,
                            hasProviders: !!window.ethereum.providers
                        });

                        // 如果有多个提供者，优先选择MetaMask
                        if (window.ethereum.providers && Array.isArray(window.ethereum.providers) && window.ethereum.providers.length > 0) {
                            const metaMaskProvider = window.ethereum.providers.find(p => p.isMetaMask) || window.ethereum.providers[0];
                            console.log('Using provider from providers array');
                            resolve(metaMaskProvider);
                        } else {
                            resolve(window.ethereum);
                        }
                        return true;
                    }
                    return false;
                };

                // 立即检查
                if (checkProvider()) {
                    return;
                }

                // 等待钱包注入（最多5秒，增加等待时间）
                let attempts = 0;
                const maxAttempts = 50; // 5秒 = 50 * 100ms
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (checkProvider()) {
                        clearInterval(checkInterval);
                        console.log('Wallet provider detected after', attempts * 100, 'ms');
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.error('Wallet provider not detected after', maxAttempts * 100, 'ms');
                        console.log('Debug info:', {
                            'window.ethereum': typeof window.ethereum,
                            'window.web3': typeof window.web3,
                            'window.ethereum?.providers': window.ethereum?.providers
                        });
                        reject(new Error('Wallet provider not detected. Please make sure MetaMask is installed and enabled.'));
                    }
                }, 100);
            });
        };

        // --- Icons Wrapper ---
        const LucideIcon = ({ name, size = 20, className, ...props }) => {
            const iconDef = window.lucide.icons[name];
            if (!iconDef) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {iconDef.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        // --- Wallet Connection Hook ---
        const useWallet = () => {
            const [account, setAccount] = useState(null);
            const [provider, setProvider] = useState(null);
            const [signer, setSigner] = useState(null);
            const [isConnecting, setIsConnecting] = useState(false);

            const connectWallet = async () => {
                // 等待 ethers.js 加载
                try {
                    await waitForEthers();
                } catch (error) {
                    alert('Failed to load ethers.js. Please refresh the page and try again.');
                    console.error('ethers.js loading error:', error);
                    return false;
                }

                // 直接检查钱包提供者（简化逻辑，恢复之前可用的方式）
                if (typeof window.ethereum === 'undefined') {
                    alert('MetaMask is not detected. Please install the MetaMask extension.');
                    return false;
                }

                // 处理多个钱包提供者的情况
                let ethereum = window.ethereum;
                if (window.ethereum.providers && Array.isArray(window.ethereum.providers) && window.ethereum.providers.length > 0) {
                    // 优先选择MetaMask
                    ethereum = window.ethereum.providers.find(p => p.isMetaMask) || window.ethereum.providers[0];
                }

                setIsConnecting(true);
                try {
                    // 请求账户访问
                    const accounts = await ethereum.request({
                        method: 'eth_requestAccounts'
                    });

                    if (accounts.length === 0) {
                        throw new Error('No wallet account authorized.');
                    }

                    // 检查网络
                    const chainId = await ethereum.request({ method: 'eth_chainId' });
                    const targetChainId = '0x' + CHAIN_ID.toString(16);

                    if (chainId !== targetChainId) {
                        try {
                            await ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: targetChainId }],
                            });
                        } catch (switchError) {
                            // 如果网络不存在，尝试添加
                            if (switchError.code === 4902) {
                                await ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: targetChainId,
                                        chainName: 'Sepolia Testnet',
                                        rpcUrls: ['https://sepolia.infura.io/v3/'],
                                        nativeCurrency: {
                                            name: 'ETH',
                                            symbol: 'ETH',
                                            decimals: 18
                                        }
                                    }],
                                });
                            } else {
                                throw switchError;
                            }
                        }
                    }

                    // 使用检测到的钱包提供者
                    const ethersProvider = new ethers.providers.Web3Provider(ethereum);
                    const ethersSigner = ethersProvider.getSigner();

                    setAccount(accounts[0]);
                    setProvider(ethersProvider);
                    setSigner(ethersSigner);

                    // 监听账户变化
                    ethereum.on('accountsChanged', (newAccounts) => {
                        if (newAccounts.length === 0) {
                            setAccount(null);
                            setProvider(null);
                            setSigner(null);
                        } else {
                            setAccount(newAccounts[0]);
                            const newProvider = new ethers.providers.Web3Provider(ethereum);
                            setProvider(newProvider);
                            setSigner(newProvider.getSigner());
                        }
                    });

                    // 监听网络变化
                    ethereum.on('chainChanged', () => {
                        window.location.reload();
                    });

                    return true;
                } catch (error) {
                    console.error('Wallet connection failed:', error);
                    alert('Wallet connection failed: ' + error.message);
                    return false;
                } finally {
                    setIsConnecting(false);
                }
            };

            const disconnectWallet = () => {
                setAccount(null);
                setProvider(null);
                setSigner(null);
                console.log('Wallet disconnected');
            };

            return { account, provider, signer, isConnecting, connectWallet, disconnectWallet };
        };

        // --- Wallet Button Component ---
        const WalletButton = ({ account, connectWallet, disconnectWallet, isConnecting }) => {
            const [showDropdown, setShowDropdown] = useState(false);


            const formatAddress = (addr) => {
                if (!addr) return '';
                return `${addr.substring(0, 6)}...${addr.substring(addr.length - 4)}`;
            };





            return (
                <div className="relative">
                    {!account ? (
                        <button
                            onClick={connectWallet}
                            disabled={isConnecting}
                            className="bg-black text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-gray-900 transition-colors shadow-lg shadow-black/10 disabled:opacity-50"
                        >
                            {isConnecting ? '连接中...' : 'Connect Wallet'}
                        </button>
                    ) : (
                        <button
                            onClick={() => setShowDropdown(!showDropdown)}
                            className="flex items-center gap-2 bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm hover:bg-gray-50 transition-colors"
                        >
                            <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span className="text-sm font-mono">{formatAddress(account)}</span>
                            <LucideIcon name="ChevronDown" size={14} className={`transition-transform ${showDropdown ? 'rotate-180' : ''}`} />
                        </button>
                    )}

                    {account && showDropdown && (
                        <>
                            {/* Backdrop to close dropdown */}
                            <div
                                className="fixed inset-0 z-40"
                                onClick={() => setShowDropdown(false)}
                            ></div>

                            {/* Dropdown menu */}
                            <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg border border-gray-200 shadow-lg z-50">
                                <div className="p-2">
                                    <button
                                        onClick={() => {
                                            disconnectWallet();
                                            setShowDropdown(false);
                                        }}
                                        className="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                    >
                                        <LucideIcon name="LogOut" size={14} />
                                        <span>Disconnect</span>
                                    </button>
                                </div>
                            </div>
                        </>
                    )}


                </div>
            );
        };

        // --- Layout Components ---

        const Navbar = ({ activeTab, setActiveTab, account, connectWallet, disconnectWallet, isConnecting }) => {
            const tabs = [
                { id: 'home', label: 'Home' },
                { id: 'solutions', label: 'Solutions' },
                { id: 'developers', label: 'Developers' },
                { id: 'company', label: 'Company' },
            ];

            return (
                <nav className="fixed top-0 left-0 right-0 z-50 h-16 glass-panel border-b border-white/20">
                    <div className="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
                        <div
                            className="flex items-center gap-2 cursor-pointer"
                            onClick={() => setActiveTab('home')}
                        >
                            <div className="w-8 h-8 bg-black rounded-lg flex items-center justify-center text-white">
                                <LucideIcon name="Ghost" size={18} />
                            </div>
                            <span className="font-semibold text-lg tracking-tight">GhostLink</span>
                        </div>

                        <div className="hidden md:flex items-center gap-1 bg-gray-100/50 p-1 rounded-full">
                            {tabs.map((tab) => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-300 ${activeTab === tab.id
                                        ? 'bg-white text-black shadow-sm'
                                        : 'text-text-muted hover:text-black'
                                        }`}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </div>

                        <WalletButton
                            account={account}
                            connectWallet={connectWallet}
                            disconnectWallet={disconnectWallet}
                            isConnecting={isConnecting}
                        />
                    </div>
                </nav>
            );
        };

        const Footer = () => (
            <footer className="bg-white border-t border-gray-100 py-12 mt-20">
                <div className="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div className="col-span-1">
                        <div className="flex items-center gap-2 mb-4">
                            <div className="w-6 h-6 bg-black rounded flex items-center justify-center text-white">
                                <LucideIcon name="Ghost" size={14} />
                            </div>
                            <span className="font-bold">GhostLink</span>
                        </div>
                        <p className="text-sm text-text-muted">© 2026 GhostLink Labs.</p>
                    </div>
                    {['Product', 'Resources', 'Company'].map((col) => (
                        <div key={col}>
                            <h4 className="font-semibold mb-4 text-sm">{col}</h4>
                            <ul className="space-y-2 text-sm text-text-muted">
                                <li>Overview</li>
                                <li>Documentation</li>
                                <li>Status</li>
                            </ul>
                        </div>
                    ))}
                </div>
            </footer>
        );

        // --- Page: Home ---

        const GlassPrismHero = () => {
            return (
                <div className="relative h-[600px] w-full flex items-center justify-center bg-[#F0F2F5] rounded-3xl overflow-hidden border border-white">
                    {/* Background Grid */}
                    <div className="absolute inset-0"
                        style={{ backgroundImage: 'radial-gradient(#CBD5E1 1px, transparent 1px)', backgroundSize: '32px 32px', opacity: 0.5 }}>
                    </div>

                    <div className="relative z-10 flex items-center gap-12 scale-90 md:scale-100">
                        {/* 1. Raw Input (Blurred Paper) */}
                        <motion.div
                            animate={{ x: [0, 150, 300], opacity: [0, 1, 0], scale: [0.8, 1, 0.8] }}
                            transition={{ duration: 4, repeat: Infinity, ease: "easeInOut" }}
                            className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-full z-0"
                        >
                            <div className="w-24 h-32 bg-white rounded shadow-sm border border-gray-200 p-2 flex flex-col gap-2 blur-[2px] opacity-70">
                                <div className="h-2 w-16 bg-gray-200 rounded"></div>
                                <div className="h-2 w-full bg-gray-100 rounded"></div>
                                <div className="h-2 w-full bg-gray-100 rounded"></div>
                                <div className="h-12 w-full bg-gray-50 rounded mt-auto"></div>
                            </div>
                            <div className="mt-4 text-center text-xs font-mono text-gray-400">Raw Data</div>
                        </motion.div>

                        {/* 2. The Prism (RISC Zero) */}
                        <div className="relative w-48 h-48 z-10">
                            {/* Glass Shape */}
                            <div className="absolute inset-0 bg-gradient-to-br from-white/80 to-blue-50/20 backdrop-blur-xl border border-white/60 rounded-[30px] shadow-prism transform rotate-45 flex items-center justify-center">
                                <div className="transform -rotate-45 text-accent opacity-50">
                                    <LucideIcon name="Cpu" size={48} strokeWidth={1} />
                                </div>
                            </div>
                            {/* Light Refraction */}
                            <div className="absolute inset-0 bg-white/30 rounded-[30px] rotate-45 animate-pulse mix-blend-overlay"></div>
                            <div className="absolute -bottom-12 left-1/2 -translate-x-1/2 font-mono text-xs text-accent font-medium tracking-wider bg-white px-2 py-1 rounded shadow-sm">
                                ZK_CIRCUIT
                            </div>
                        </div>

                        {/* 3. Output (Gold Coin) */}
                        <motion.div
                            animate={{ x: [-100, 100], opacity: [0, 0, 1, 0] }}
                            transition={{ duration: 4, repeat: Infinity, times: [0, 0.6, 0.8, 1] }}
                            className="absolute right-0 top-1/2 -translate-y-1/2 z-0"
                        >
                            <div className="w-20 h-20 bg-gradient-to-br from-yellow-200 to-yellow-500 rounded-full shadow-lg flex items-center justify-center border-4 border-white">
                                <div className="w-12 h-12 border-2 border-yellow-100/50 rounded-full flex items-center justify-center text-white font-bold text-xl">
                                    GL
                                </div>
                            </div>
                            <div className="mt-4 text-center text-xs font-mono text-gray-800 font-bold">Proof Asset</div>
                        </motion.div>
                    </div>
                </div>
            );
        };

        const HomePage = () => {
            return (
                <div className="space-y-24 pb-20">
                    {/* Hero Section */}
                    <section className="pt-32 px-6 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
                        <div className="space-y-8">
                            <motion.div
                                initial={{ opacity: 0, y: 10 }}
                                animate={{ opacity: 1, y: 0 }}
                                className="inline-flex items-center gap-2 px-3 py-1 bg-white border border-gray-200 rounded-full text-xs font-medium text-text-muted shadow-sm"
                            >
                                <span className="w-2 h-2 bg-accent rounded-full animate-pulse"></span>
                                Now Live on Mainnet
                            </motion.div>
                            <motion.h1
                                initial={{ opacity: 0, y: 20 }}
                                animate={{ opacity: 1, y: 0 }}
                                transition={{ delay: 0.1 }}
                                className="text-5xl md:text-7xl font-bold tracking-tight leading-[1.1] text-text"
                            >
                                Prove it’s you, <br />
                                <span className="text-text-muted">without revealing who you are.</span>
                            </motion.h1>
                            <motion.p
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                transition={{ delay: 0.2 }}
                                className="text-xl text-text-muted max-w-md leading-relaxed"
                            >
                                GhostLink turns your GitHub, PayPal, and Uber history into on-chain reputation badges.
                                <span className="text-text font-medium"> Private. Verifiable. Built on RISC Zero.</span>
                            </motion.p>
                            <motion.div
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                transition={{ delay: 0.3 }}
                                className="flex items-center gap-4"
                            >
                                <button className="px-8 py-4 bg-text text-white rounded-xl font-medium hover:bg-black/80 transition-all shadow-lg shadow-black/10">
                                    Connect Wallet
                                </button>
                                <button className="px-8 py-4 bg-white border border-gray-200 text-text rounded-xl font-medium hover:bg-gray-50 transition-all">
                                    View Demo
                                </button>
                            </motion.div>
                        </div>

                        <div className="relative">
                            <GlassPrismHero />
                        </div>
                    </section>

                    {/* Architecture Section */}
                    <section className="px-6 max-w-7xl mx-auto">
                        <div className="bg-white rounded-3xl p-16 border border-gray-100 shadow-sm relative overflow-hidden">
                            <div className="absolute inset-0 pointer-events-none opacity-[0.03]"
                                style={{ backgroundImage: 'linear-gradient(90deg, #000 1px, transparent 1px)', backgroundSize: '40px 100%' }}>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-12 relative z-10">
                                {/* Step 1 */}
                                <div className="flex flex-col items-center text-center space-y-4 group">
                                    <div className="w-20 h-20 bg-[#F5F5F7] rounded-2xl flex items-center justify-center mb-4 group-hover:scale-105 transition-transform duration-500">
                                        <LucideIcon name="Smartphone" size={32} className="text-gray-400 group-hover:text-black transition-colors" />
                                    </div>
                                    <h3 className="font-semibold text-lg">User Local</h3>
                                    <p className="text-sm text-text-muted">Data stays on your device.<br />TLS encryption intact.</p>
                                </div>
                                {/* Step 2 */}
                                <div className="flex flex-col items-center text-center space-y-4 group">
                                    <div className="w-20 h-20 bg-white border border-blue-100 shadow-prism rounded-2xl flex items-center justify-center mb-4 relative overflow-hidden">
                                        <div className="absolute inset-0 bg-blue-50/50"></div>
                                        <LucideIcon name="Cpu" size={32} className="text-accent relative z-10" />
                                    </div>
                                    <h3 className="font-semibold text-lg text-accent">ZK Processor</h3>
                                    <p className="text-sm text-text-muted">Mathematical Proof generated<br />in isolated environment.</p>
                                </div>
                                {/* Step 3 */}
                                <div className="flex flex-col items-center text-center space-y-4 group">
                                    <div className="w-20 h-20 bg-[#F5F5F7] rounded-2xl flex items-center justify-center mb-4 group-hover:scale-105 transition-transform duration-500">
                                        <LucideIcon name="Blocks" size={32} className="text-gray-400 group-hover:text-black transition-colors" />
                                    </div>
                                    <h3 className="font-semibold text-lg">Blockchain</h3>
                                    <p className="text-sm text-text-muted">Public Verification.<br />Smart Contract composability.</p>
                                </div>
                            </div>

                            {/* Connecting Line with flowing dot */}
                            <div className="absolute top-[35%] left-[16%] right-[16%] h-[2px] bg-gray-100 -z-10 hidden md:block">
                                <motion.div
                                    animate={{ x: ['0%', '100%'], opacity: [0, 1, 0] }}
                                    transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}
                                    className="w-20 h-full bg-gradient-to-r from-transparent via-accent to-transparent"
                                />
                            </div>
                        </div>
                    </section>

                    {/* Trust Battery */}
                    <section className="text-center pb-20">
                        <p className="text-sm font-semibold tracking-wide text-text-muted uppercase mb-8">Trusted Infrastructure</p>
                        <div className="flex flex-wrap justify-center gap-12 opacity-50 grayscale hover:grayscale-0 transition-all duration-500">
                            {/* Simple text placeholders for logos to maintain clean code */}
                            <span className="text-xl font-bold font-mono">RISC ZERO</span>
                            <span className="text-xl font-bold font-mono">ETHEREAL</span>
                            <span className="text-xl font-bold font-mono">TLSNotary</span>
                            <span className="text-xl font-bold font-mono">StarkWare</span>
                        </div>
                    </section>
                </div>
            );
        };

        // --- Progress Modal Component ---
        const ProgressModal = ({ isOpen, onClose, title, steps, currentStep }) => {
            if (!isOpen) return null;

            const stepStatus = (stepIndex) => {
                // When currentStep >= steps.length, we treat the whole flow as completed (so the last row shows ✅).
                if (currentStep >= steps.length) return 'completed';
                if (stepIndex < currentStep) return 'completed';
                if (stepIndex === currentStep) return 'active';
                return 'pending';
            };

            const getStepIcon = (status) => {
                if (status === 'completed') {
                    return <LucideIcon name="Check" size={20} className="text-green-600" />;
                }
                if (status === 'active') {
                    return <div className="w-5 h-5 border-2 border-accent border-t-transparent rounded-full animate-spin"></div>;
                }
                return <div className="w-5 h-5 border-2 border-gray-300 rounded-full"></div>;
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-md">
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="bg-white rounded-2xl p-6 max-w-md w-full mx-4 border border-gray-200 shadow-xl"
                    >
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-semibold tracking-tight">{title || 'Progress'}</h3>
                            {currentStep >= steps.length && (
                                <button
                                    onClick={onClose}
                                    className="text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    <LucideIcon name="X" size={20} />
                                </button>
                            )}
                        </div>

                        <div className="space-y-2">
                            {steps.map((step, index) => {
                                const status = stepStatus(index);
                                const isLast = index === steps.length - 1;
                                return (
                                    <div key={index} className="relative">
                                        <div
                                            className={`flex items-start gap-3 px-4 py-3 rounded-xl border transition-colors ${status === 'active'
                                                ? 'border-accent bg-blue-50/40'
                                                : status === 'completed'
                                                    ? 'border-green-200 bg-green-50/40'
                                                    : 'border-gray-200 bg-gray-50/30'
                                                }`}
                                        >
                                            <div className="flex flex-col items-center w-6">
                                                {getStepIcon(status)}
                                                {!isLast && (
                                                    <div className="mt-2 text-gray-300">
                                                        <LucideIcon name="ArrowDown" size={16} />
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className={`text-sm font-medium ${status === 'active'
                                                    ? 'text-accent'
                                                    : status === 'completed'
                                                        ? 'text-green-700'
                                                        : 'text-gray-700'
                                                    }`}>
                                                    {step.title}
                                                </div>
                                                {step.description && (
                                                    <div className="text-xs text-gray-600 mt-1">
                                                        {step.description}
                                                    </div>
                                                )}
                                                {step.details && (status === 'active' || status === 'completed') && (
                                                    <div className={`text-[11px] mt-2 font-mono break-all ${status === 'completed' ? 'text-green-700' : 'text-gray-700'
                                                        }`}>
                                                        {step.details}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {currentStep >= steps.length && (
                            <motion.div
                                initial={{ opacity: 0, y: 10 }}
                                animate={{ opacity: 1, y: 0 }}
                                className="mt-6 pt-6 border-t border-gray-200"
                            >
                                <button
                                    onClick={onClose}
                                    className="w-full bg-black text-white py-2.5 rounded-lg font-medium hover:bg-gray-900 transition-colors"
                                >
                                    Close
                                </button>
                            </motion.div>
                        )}
                    </motion.div>
                </div>
            );
        };

        // --- Contract Interaction Functions ---
        const useContract = (signer, account) => {
            const [isMinting, setIsMinting] = useState(false);
            const [mintStatus, setMintStatus] = useState(null);
            const [progressSteps, setProgressSteps] = useState([]);
            const [currentProgressStep, setCurrentProgressStep] = useState(0);
            const [showProgressModal, setShowProgressModal] = useState(false);
            const [progressTitle, setProgressTitle] = useState('Progress');

            const defaultProgressSteps = [
                { title: 'Generate ZK Proof', description: 'Prover is running… this may take a few minutes.' },
                { title: 'Prepare Transaction', description: 'Preparing contract parameters…' },
                { title: 'Confirm in Wallet', description: 'Please confirm in your wallet.' },
                { title: 'Await Confirmation', description: 'Waiting for on-chain confirmation…' },
                { title: 'Completed', description: 'Done.' }
            ];
            const TOTAL_STEPS = defaultProgressSteps.length;

            const ensureProgressInitialized = (titleOverride) => {
                setProgressTitle(titleOverride || 'Progress');
                setProgressSteps(prev => (prev && prev.length > 0 ? prev : defaultProgressSteps));
            };

            const mintCredential = async (zkProof, credentialType, autoStart = false) => {
                // 等待 ethers.js 加载
                try {
                    await waitForEthers();
                } catch (error) {
                    alert('Ethers.js 库加载失败，请刷新页面重试');
                    console.error('ethers.js loading error:', error);
                    return false;
                }

                if (!signer || !account) {
                    alert('Please connect your wallet first.');
                    return false;
                }

                if (!zkProof) {
                    alert('Missing zero-knowledge proof data.');
                    return false;
                }

                setIsMinting(true);

                console.log('mintCredential 被调用', { zkProof, credentialType, autoStart });

                // Ensure progress exists; proof generation step may already be in-progress from SolutionsPage.
                ensureProgressInitialized('Proof → Mint');
                if (autoStart) {
                    console.log('显示进度弹窗');
                    setShowProgressModal(true);
                }

                try {
                    // Mark proof step as completed (proof is already provided by backend).
                    setProgressSteps(prev => prev.map((s, i) =>
                        i === 0 ? { ...s, description: 'Proof ready', details: `Proof ID: ${zkProof.proofId || 'N/A'}` } : s
                    ));

                    // 步骤2: 准备交易
                    setCurrentProgressStep(1);
                    setProgressSteps(prev => prev.map((s, i) =>
                        i === 1 ? { ...s, description: 'Transaction parameters ready' } : s
                    ));

                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    // ===== 根据调用指导.md文档，使用 mint 接口 =====
                    // mint(bytes calldata seal, address recipient, bytes32 nullifier)
                    // seal: receipt_hex（添加 0x 前缀）
                    // recipient: 当前钱包地址（必须与 msg.sender 一致）
                    // nullifier: nullifier_hex（添加 0x 前缀）

                    // 获取当前钱包地址作为 recipient（必须与 msg.sender 一致）
                    const currentAddress = await signer.getAddress();
                    const mintRecipient = ethers.utils.getAddress(currentAddress); // 标准化地址

                    // 准备 seal（receipt）- 参考 test.html 的处理方式
                    let seal;
                    if (zkProof.receipt) {
                        // receipt 应该是 bytes 格式，确保有 0x 前缀
                        seal = typeof zkProof.receipt === 'string' ? zkProof.receipt : String(zkProof.receipt);

                        // 确保有 0x 前缀（参考 test.html）
                        if (!seal.startsWith('0x')) {
                            seal = '0x' + seal;
                        }

                        // 验证 seal 格式
                        if (!seal || seal.length < 10) {
                            throw new Error('Invalid seal format');
                        }

                        console.log('Seal length:', seal.length, 'chars');
                    } else {
                        throw new Error('Missing receipt in zkProof');
                    }

                    // 准备 nullifier（参考 test.html 的处理方式）
                    let nullifier;
                    if (zkProof.nullifier) {
                        // 参考 test.html：先移除可能存在的 0x 前缀，然后验证格式，再添加 0x 前缀
                        nullifier = typeof zkProof.nullifier === 'string' ? zkProof.nullifier : String(zkProof.nullifier);

                        // 移除可能存在的 0x 前缀
                        if (nullifier.startsWith('0x')) {
                            nullifier = nullifier.substring(2);
                        }

                        // 确保是 64 个十六进制字符
                        if (nullifier.length !== 64) {
                            throw new Error(`Invalid nullifier length: expected 64 hex chars, got ${nullifier.length}. Value: ${nullifier}`);
                        }

                        // 验证是否为有效的十六进制
                        if (!/^[0-9a-fA-F]{64}$/.test(nullifier)) {
                            throw new Error(`Invalid nullifier format: must be 64 hex characters. Value: ${nullifier}`);
                        }

                        // 添加 0x 前缀
                        nullifier = '0x' + nullifier;

                        // 使用 ethers.utils.hexlify 确保格式正确（参考 test.html）
                        // 注意：只处理一次，之后不再修改 nullifier
                        try {
                            nullifier = ethers.utils.hexlify(nullifier);
                            console.log('✅ Nullifier format validated:', nullifier);
                            console.log('Nullifier length:', nullifier.length, '(should be 66)');
                        } catch (e) {
                            console.error('❌ Nullifier format error:', e);
                            throw new Error(`Invalid nullifier format: ${e.message}. Value: ${nullifier}`);
                        }

                        // 最终验证 nullifier 长度
                        if (nullifier.length !== 66) {
                            throw new Error(`Invalid nullifier format. Expected 66 chars, got ${nullifier.length}: ${nullifier}`);
                        }
                    } else {
                        throw new Error('Missing nullifier in zkProof');
                    }

                    // 验证 Image ID（可选，但建议）
                    // 注意：ethers.js v5 中，view 函数可以直接调用或使用 functions.xxx()
                    if (zkProof.imageId) {
                        try {
                            const contractImageId = await contract.functions.imageId();
                            const proofImageId = zkProof.imageId.startsWith('0x')
                                ? zkProof.imageId
                                : '0x' + zkProof.imageId;
                            if (contractImageId.toLowerCase() !== proofImageId.toLowerCase()) {
                                throw new Error(`Image ID mismatch! Contract: ${contractImageId}, Proof: ${proofImageId}`);
                            }
                            console.log('✅ Image ID verified:', contractImageId);
                        } catch (imageIdError) {
                            console.warn('Image ID verification failed:', imageIdError.message);
                            // 不阻止继续，但记录警告
                        }
                    }

                    // 检查 nullifier 是否已使用（使用处理后的 nullifier）
                    // 注意：ethers.js v5 中，view 函数可以直接调用或使用 functions.xxx()
                    console.log('=== Checking Nullifier ===');
                    console.log('Nullifier value:', nullifier);
                    console.log('Nullifier type:', typeof nullifier);
                    console.log('Nullifier length:', nullifier.length);
                    console.log('Nullifier starts with 0x:', nullifier.startsWith('0x'));
                    console.log('Nullifier (lowercase):', nullifier.toLowerCase());
                    console.log('Nullifier (uppercase):', nullifier.toUpperCase());

                    try {
                        // 检查 nullifier 是否已使用
                        const nullifierUsed = await contract.functions.nullifiers(nullifier);
                        console.log('Nullifier check result:', nullifierUsed);
                        console.log('Nullifier check result type:', typeof nullifierUsed);
                        console.log('Nullifier check result (boolean):', Boolean(nullifierUsed));
                        console.log('Nullifier check result (string):', String(nullifierUsed));

                        // 检查多种可能的 true 值表示方式
                        const isUsed = nullifierUsed === true ||
                            nullifierUsed === 1 ||
                            nullifierUsed === 'true' ||
                            nullifierUsed === '1' ||
                            String(nullifierUsed).toLowerCase() === 'true';

                        if (isUsed) {
                            console.error('❌ Nullifier already used!');
                            console.error('Nullifier value that was checked:', nullifier);
                            console.error('Please generate a new proof with different data.');
                            throw new Error('This proof has already been used! The nullifier: ' + nullifier + '. Please generate a new proof.');
                        }
                        console.log('✅ Nullifier available (not used)');
                    } catch (nullifierError) {
                        console.error('Nullifier check error:', nullifierError);
                        console.error('Error details:', {
                            message: nullifierError.message,
                            reason: nullifierError.reason,
                            code: nullifierError.code,
                            data: nullifierError.data
                        });

                        if (nullifierError.message && nullifierError.message.includes('already been used')) {
                            throw nullifierError;
                        }
                        // 如果不是"已使用"的错误，继续执行（可能是网络错误等）
                        console.warn('Nullifier check failed (non-critical):', nullifierError.message);
                    }

                    // 步骤3: 提交交易
                    setCurrentProgressStep(2);
                    setProgressSteps(prev => prev.map((s, i) =>
                        i === 2 ? { ...s, description: 'Please confirm in your wallet' } : s
                    ));

                    setMintStatus({ type: 'pending', message: 'Waiting for wallet confirmation...' });

                    // 最终验证参数格式（在调用前再次确认，参考 test.html）
                    // 注意：nullifier 已经在前面处理过了，这里只验证，不再修改
                    console.log('Final parameter validation before contract call:');
                    console.log('  seal:', seal.substring(0, 30) + '...', 'starts with 0x:', seal.startsWith('0x'), 'length:', seal.length);
                    console.log('  mintRecipient:', mintRecipient, 'is valid:', ethers.utils.isAddress(mintRecipient), 'length:', mintRecipient.length);
                    console.log('  nullifier:', nullifier, 'starts with 0x:', nullifier.startsWith('0x'), 'length:', nullifier.length);

                    // 验证 nullifier 格式（不修改，只验证）
                    if (!nullifier.startsWith('0x')) {
                        throw new Error('❌ CRITICAL: Nullifier missing 0x prefix! Current value: ' + nullifier);
                    }

                    if (nullifier.length !== 66) {
                        throw new Error(`Invalid nullifier format. Expected 66 chars, got ${nullifier.length}: ${nullifier}`);
                    }

                    console.log('准备调用合约 mint，参数:', {
                        seal: seal.substring(0, 20) + '...',
                        recipient: mintRecipient,
                        nullifier: nullifier,
                        contractAddress: CONTRACT_ADDRESS
                    });

                    // 模拟交易以获取详细错误（可选）
                    // 注意：ethers.js v5 使用 contract.callStatic.<fn>(...) 的形式
                    try {
                        await contract.callStatic.mint(seal, mintRecipient, nullifier);
                        console.log('✅ Transaction simulation passed');
                    } catch (simError) {
                        console.error('Transaction simulation failed:', simError);
                        const errorMsg = simError.reason || simError.message || '交易模拟失败';
                        throw new Error(`交易将失败: ${errorMsg}`);
                    }

                    // 估算gas，如果失败则使用固定值
                    // 注意：ethers.js v5 使用 contract.estimateGas.<fn>(...) 的形式
                    let gasEstimate;
                    try {
                        gasEstimate = await contract.estimateGas.mint(seal, mintRecipient, nullifier);
                        console.log('Gas估算成功:', gasEstimate.toString());
                    } catch (estimateError) {
                        console.warn('Gas估算失败，使用固定值:', estimateError.message);
                        // 使用一个较大的固定gas limit（根据实际合约调整）
                        gasEstimate = ethers.BigNumber.from('500000'); // 500k gas
                    }

                    // 调用合约，设置gas limit
                    // 注意：ethers.js v5 直接用 contract.<fn>(...) 发送交易
                    const tx = await contract.mint(seal, mintRecipient, nullifier, {
                        gasLimit: gasEstimate.mul(120).div(100) // 增加20%的gas buffer
                    });

                    // 步骤4: 等待确认
                    setCurrentProgressStep(3);
                    setProgressSteps(prev => prev.map((s, i) =>
                        i === 3 ? {
                            ...s,
                            description: 'Transaction submitted, waiting for confirmation...',
                            details: `Tx hash: ${tx.hash.substring(0, 10)}...`
                        } : s
                    ));

                    setMintStatus({ type: 'pending', message: 'Transaction submitted, waiting for confirmation...', txHash: tx.hash });

                    // 等待交易确认
                    const receipt_tx = await tx.wait();

                    // 步骤5: 完成
                    setCurrentProgressStep(TOTAL_STEPS); // mark all as completed (fixes “Completed spinning”)
                    setProgressSteps(prev => prev.map((s, i) =>
                        i === 4 ? {
                            ...s,
                            description: 'Credential minted successfully.',
                            details: `Block: ${receipt_tx.blockNumber} · Tx: ${receipt_tx.transactionHash.substring(0, 10)}...`
                        } : s
                    ));

                    setMintStatus({
                        type: 'success',
                        message: 'Credential minted successfully.',
                        txHash: receipt_tx.transactionHash
                    });

                    return true;
                } catch (error) {
                    console.error('上链失败:', error);
                    let errorMessage = 'Transaction failed.';
                    if (error.code === 4001) {
                        errorMessage = 'User rejected the transaction.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    setMintStatus({ type: 'error', message: errorMessage });
                    setProgressSteps(prev => prev.map((s, i) =>
                        i === currentProgressStep ? { ...s, description: `失败: ${errorMessage}` } : s
                    ));
                    // allow closing the modal on failure
                    setCurrentProgressStep(TOTAL_STEPS);
                    return false;
                } finally {
                    setIsMinting(false);
                }
            };

            return {
                mintCredential,
                isMinting,
                mintStatus,
                progressSteps,
                currentProgressStep,
                showProgressModal,
                setShowProgressModal,
                setProgressSteps,
                setCurrentProgressStep,
                progressTitle,
                setProgressTitle,
                defaultProgressSteps,
                ensureProgressInitialized
            };
        };

        // --- Page: Solutions ---

        const SolutionsPage = ({
            initialVerificationStatus, initialUserData, initialZkProof, onGithubConnect,
            twitterStatus, twitterUser, twitterProof, onTwitterConnect,
            walletAccount, walletSigner
        }) => {
            const [activeTab, setActiveTab] = useState('identity');
            // Use the wallet info passed from parent (App component)
            const account = walletAccount;
            const signer = walletSigner;

            const {
                mintCredential,
                isMinting,
                mintStatus,
                progressSteps,
                currentProgressStep,
                showProgressModal,
                setShowProgressModal,
                setProgressSteps,
                setCurrentProgressStep,
                progressTitle,
                setProgressTitle,
                defaultProgressSteps,
                ensureProgressInitialized
            } = useContract(signer, account);

            // Show progress modal as soon as backend starts generating proof (loading state)
            useEffect(() => {
                const githubLoading = initialVerificationStatus === 'loading';
                const twitterLoading = twitterStatus === 'loading';

                if (githubLoading) {
                    ensureProgressInitialized('GitHub · Proof → Mint');
                    setProgressSteps(defaultProgressSteps);
                    setCurrentProgressStep(0);
                    setShowProgressModal(true);
                    return;
                }

                if (twitterLoading) {
                    ensureProgressInitialized('X · Proof → Mint');
                    setProgressSteps(defaultProgressSteps);
                    setCurrentProgressStep(0);
                    setShowProgressModal(true);
                }
            }, [initialVerificationStatus, twitterStatus]);

            // When proof arrives, mark step 0 as completed.
            // We only advance to "Prepare Transaction" if the wallet is connected (so it won't look “stuck”).
            useEffect(() => {
                if (initialVerificationStatus === 'success' && initialZkProof) {
                    setProgressTitle('GitHub · Proof → Mint');
                    setProgressSteps(prev => (prev && prev.length > 0 ? prev : defaultProgressSteps));
                    setProgressSteps(prev => prev.map((s, i) =>
                        i === 0 ? { ...s, description: 'Proof ready', details: `Proof ID: ${initialZkProof.proofId || 'N/A'}` } : s
                    ));
                    if (account && signer) {
                        setCurrentProgressStep(1);
                    } else {
                        setProgressSteps(prev => prev.map((s, i) =>
                            i === 1 ? { ...s, description: 'Connect wallet to continue.' } : s
                        ));
                        setCurrentProgressStep(1);
                    }
                }
            }, [initialVerificationStatus, initialZkProof]);

            useEffect(() => {
                if (twitterStatus === 'success' && twitterProof) {
                    setProgressTitle('X · Proof → Mint');
                    setProgressSteps(prev => (prev && prev.length > 0 ? prev : defaultProgressSteps));
                    setProgressSteps(prev => prev.map((s, i) =>
                        i === 0 ? { ...s, description: 'Proof ready', details: `Proof ID: ${twitterProof.proofId || 'N/A'}` } : s
                    ));
                    if (account && signer) {
                        setCurrentProgressStep(1);
                    } else {
                        setProgressSteps(prev => prev.map((s, i) =>
                            i === 1 ? { ...s, description: 'Connect wallet to continue.' } : s
                        ));
                        setCurrentProgressStep(1);
                    }
                }
            }, [twitterStatus, twitterProof]);

            // 当授权成功且有钱包连接时，自动触发上链
            const githubAutoMintedRef = React.useRef(false);
            const twitterAutoMintedRef = React.useRef(false);

            useEffect(() => {
                if (initialVerificationStatus === 'success' && account && initialZkProof && !isMinting && !githubAutoMintedRef.current) {
                    githubAutoMintedRef.current = true;
                    console.log('GitHub验证成功，准备自动上链...', { account, zkProof: initialZkProof });
                    // 延迟一下，让用户看到验证成功的状态
                    const timer = setTimeout(() => {
                        console.log('开始自动上链...');
                        mintCredential(initialZkProof, 0, true); // autoStart = true
                    }, 1500);
                    return () => clearTimeout(timer);
                }
            }, [initialVerificationStatus, account, initialZkProof, isMinting]);

            useEffect(() => {
                if (twitterStatus === 'success' && account && twitterProof && !isMinting && !twitterAutoMintedRef.current) {
                    twitterAutoMintedRef.current = true;
                    console.log('Twitter验证成功，准备自动上链...', { account, zkProof: twitterProof });
                    const timer = setTimeout(() => {
                        console.log('开始自动上链...');
                        mintCredential(twitterProof, 1, true); // autoStart = true
                    }, 1500);
                    return () => clearTimeout(timer);
                }
            }, [twitterStatus, account, twitterProof, isMinting]);

            const tabContent = {
                defi: {
                    title: "Enable under-collateralized loans.",
                    desc: "Import off-chain credit history from PayPal or Stripe to prove solvency without revealing transactions.",
                    mockup: (
                        <div className="bg-white rounded-xl shadow-lg border border-gray-100 p-6 h-full flex flex-col">
                            <div className="flex justify-between items-center mb-8 border-b border-gray-100 pb-4">
                                <div className="font-bold">Aave Loan Market</div>
                                <div className="bg-gray-100 px-3 py-1 rounded-full text-xs">Wallet Connected</div>
                            </div>
                            <div className="space-y-4">
                                <div className="p-4 bg-blue-50 border border-blue-100 rounded-lg flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-accent">
                                            <LucideIcon name="ShieldCheck" size={16} />
                                        </div>
                                        <div>
                                            <div className="text-sm font-bold text-gray-900">GhostLink Score</div>
                                            <div className="text-xs text-gray-500">Source: PayPal</div>
                                        </div>
                                    </div>
                                    <div className="text-lg font-bold text-accent">780</div>
                                </div>
                                <div className="space-y-2">
                                    <div className="flex justify-between text-sm">
                                        <span className="text-gray-500">Max LTV</span>
                                        <span className="font-medium text-green-600">85% (Boosted)</span>
                                    </div>
                                    <div className="w-full bg-gray-100 rounded-full h-2">
                                        <div className="w-[85%] bg-green-500 h-2 rounded-full"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )
                },
                growth: {
                    title: "Stop bots. Reward humans.",
                    desc: "Verify users based on real-world spending power (e.g. Uber rides > 5) to prevent Sybil attacks.",
                    mockup: (
                        <div className="bg-white rounded-xl shadow-lg border border-gray-100 p-6 h-full flex flex-col">
                            <div className="text-center mb-8">
                                <div className="w-12 h-12 bg-black rounded-full mx-auto mb-2"></div>
                                <div className="font-bold">Exclusive Airdrop</div>
                            </div>
                            <button className="w-full py-3 bg-gray-100 text-gray-400 rounded-lg font-medium cursor-not-allowed mb-3">
                                Claim Tokens (Locked)
                            </button>
                            <button className="w-full py-3 bg-black text-white rounded-lg font-medium flex items-center justify-center gap-2">
                                <LucideIcon name="Car" size={16} />
                                Verify Uber History
                            </button>
                            <p className="text-center text-xs text-green-600 mt-2 flex items-center justify-center gap-1">
                                <LucideIcon name="Check" size={12} />
                                Requirement: 5+ Rides
                            </p>
                        </div>
                    )
                },
                identity: {
                    title: "One Person, One ID.",
                    desc: "Link multiple Web2 accounts (Twitter, GitHub, Email) to create a robust, private on-chain identity.",
                    mockup: (
                        <div className="bg-white rounded-xl shadow-lg border border-gray-100 p-6 h-full flex flex-col">
                            <div className="font-bold mb-6">My Identity Orb</div>
                            <div className="space-y-3">
                                {/* GitHub Item */}
                                <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div className="flex items-center gap-3">
                                        <LucideIcon name="Github" size={18} />
                                        <span className="text-sm">GitHub</span>
                                    </div>
                                    {initialVerificationStatus === 'success' ? (
                                        <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded flex items-center gap-1">
                                            <LucideIcon name="Check" size={10} /> Verified
                                        </span>
                                    ) : (
                                        <button
                                            onClick={onGithubConnect}
                                            disabled={initialVerificationStatus === 'loading'}
                                            className="text-xs px-3 py-1.5 rounded transition-colors bg-black text-white hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {initialVerificationStatus === 'loading' ? 'Verifying...' : 'Connect'}
                                        </button>
                                    )}
                                </div>

                                {/* Success Details - Simplified (Minting is automatic) */}
                                {initialVerificationStatus === 'success' && (
                                    <motion.div
                                        initial={{ height: 0, opacity: 0 }}
                                        animate={{ height: 'auto', opacity: 1 }}
                                        className="text-xs bg-green-50 p-2 rounded border border-green-100 text-green-800"
                                    >
                                        <p><strong>User:</strong> {initialUserData?.login}</p>
                                        <p className="text-[10px] text-green-600 mt-1">✓ Credential minting in progress...</p>
                                    </motion.div>
                                )}

                                {/* Twitter Item */}
                                <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div className="flex items-center gap-3">
                                        <LucideIcon name="Twitter" size={18} />
                                        <span className="text-sm">X (Twitter)</span>
                                    </div>
                                    {twitterStatus === 'success' ? (
                                        <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded flex items-center gap-1">
                                            <LucideIcon name="Check" size={10} /> Verified
                                        </span>
                                    ) : (
                                        <button
                                            onClick={onTwitterConnect}
                                            disabled={twitterStatus === 'loading'}
                                            className="text-xs px-3 py-1.5 rounded transition-colors bg-black text-white hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {twitterStatus === 'loading' ? 'Verifying...' : 'Connect'}
                                        </button>
                                    )}
                                </div>
                                {twitterStatus === 'success' && (
                                    <motion.div
                                        initial={{ height: 0, opacity: 0 }}
                                        animate={{ height: 'auto', opacity: 1 }}
                                        className="text-xs bg-green-50 p-2 rounded border border-green-100 text-green-800"
                                    >
                                        <p><strong>User:</strong> {twitterUser?.username || 'Verified'}</p>
                                        <p className="text-[10px] text-green-600 mt-1">✓ Credential minting in progress...</p>
                                    </motion.div>
                                )}

                                <div className="flex items-center justify-between p-3 border border-dashed border-gray-300 rounded-lg text-gray-400">
                                    <div className="flex items-center gap-3">
                                        <LucideIcon name="Plus" size={18} />
                                        <span className="text-sm">Add Source</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )
                }
            };

            return (
                <>
                    <ProgressModal
                        isOpen={showProgressModal}
                        onClose={() => {
                            setShowProgressModal(false);
                        }}
                        title={progressTitle}
                        steps={progressSteps}
                        currentStep={currentProgressStep}
                    />
                    <div className="pt-32 pb-20 px-6 max-w-7xl mx-auto">
                        <div className="text-center max-w-2xl mx-auto mb-16">
                            <h2 className="text-4xl font-bold mb-4">Unlock the value of Web2 data.</h2>
                            <p className="text-text-muted">Bridge the gap between off-chain reputation and on-chain utility.</p>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-12">
                            {/* Tabs Navigation (Left) */}
                            <div className="lg:col-span-4 flex flex-col gap-2">
                                {Object.keys(tabContent).map((key) => (
                                    <div
                                        key={key}
                                        onClick={() => setActiveTab(key)}
                                        className={`p-6 rounded-2xl cursor-pointer transition-all duration-300 border ${activeTab === key
                                            ? 'bg-white border-gray-200 shadow-sm'
                                            : 'bg-transparent border-transparent hover:bg-white/50'
                                            }`}
                                    >
                                        <h3 className={`font-semibold text-lg mb-1 ${activeTab === key ? 'text-accent' : 'text-text'}`}>
                                            {key.charAt(0).toUpperCase() + key.slice(1)}
                                        </h3>
                                        <p className="text-sm text-text-muted leading-relaxed">
                                            {activeTab === key ? tabContent[key].desc : ""}
                                        </p>
                                    </div>
                                ))}
                            </div>

                            {/* Visual Mockup (Right) */}
                            <div className="lg:col-span-8">
                                <div className="bg-[#F0F2F5] p-8 rounded-3xl h-[500px] flex items-center justify-center relative overflow-hidden">
                                    <motion.div
                                        key={activeTab}
                                        initial={{ opacity: 0, scale: 0.95 }}
                                        animate={{ opacity: 1, scale: 1 }}
                                        transition={{ duration: 0.4 }}
                                        className="w-full max-w-md"
                                    >
                                        {tabContent[activeTab].mockup}
                                    </motion.div>
                                </div>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // --- Page: Developers ---

        const DevelopersPage = () => {
            return (
                <div className="pt-32 pb-20 px-6 max-w-7xl mx-auto">
                    {/* Integration Section */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start mb-24">
                        <div className="sticky top-32">
                            <h2 className="text-4xl font-bold mb-6">Import. Verify. Mint.</h2>
                            <p className="text-text-muted text-lg mb-8">
                                Use our Rust SDK to build custom data parsers.
                                Define verification logic in standard Rust, and we handle the ZK circuit compilation.
                            </p>
                            <div className="flex flex-col gap-4">
                                <div className="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                                    <div className="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-accent">1</div>
                                    <span className="font-medium">Install Rust SDK</span>
                                </div>
                                <div className="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                                    <div className="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-accent">2</div>
                                    <span className="font-medium">Write Parser Logic</span>
                                </div>
                                <div className="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                                    <div className="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-accent">3</div>
                                    <span className="font-medium">Deploy to GhostLink Network</span>
                                </div>
                            </div>
                        </div>

                        {/* Code Editor */}
                        <div className="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden font-mono text-sm">
                            <div className="bg-gray-50 border-b border-gray-200 px-4 py-3 flex items-center gap-2">
                                <div className="flex gap-1.5">
                                    <div className="w-3 h-3 rounded-full bg-gray-300"></div>
                                    <div className="w-3 h-3 rounded-full bg-gray-300"></div>
                                    <div className="w-3 h-3 rounded-full bg-gray-300"></div>
                                </div>
                                <span className="ml-4 text-xs text-gray-500">main.rs</span>
                            </div>
                            <div className="p-6 overflow-x-auto text-gray-800 leading-relaxed">
                                <div><span className="text-purple-600">use</span> ghostlink_sdk::prelude::*;</div>
                                <br />
                                <div><span className="text-blue-600">fn</span> <span className="text-yellow-600">main</span>() &#123;</div>
                                <div className="pl-4"><span className="text-gray-400">// Read data from host</span></div>
                                <div className="pl-4"><span className="text-purple-600">let</span> input: <span className="text-yellow-600">String</span> = env::<span className="text-blue-600">read</span>();</div>
                                <br />
                                <div className="pl-4"><span className="text-gray-400">// Verify JSON structure</span></div>
                                <div className="pl-4"><span className="text-purple-600">let</span> data: <span className="text-yellow-600">PayPalData</span> = serde_json::<span className="text-blue-600">from_str</span>(&input).unwrap();</div>
                                <br />
                                <div className="pl-4"><span className="text-purple-600">if</span> data.balance &gt; <span className="text-blue-600">1000.0</span> &#123;</div>
                                <div className="pl-8">env::<span className="text-blue-600">commit</span>(&quot;<span className="text-green-600">SOLVENT</span>&quot;);</div>
                                <div className="pl-4">&#125;</div>
                                <div>&#125;</div>
                            </div>
                        </div>
                    </div>

                    {/* Marketplace */}
                    <div>
                        <h3 className="text-2xl font-bold mb-8">Parser Marketplace</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                            {[
                                { name: 'GitHub', status: 'Live', color: 'bg-green-100 text-green-700' },
                                { name: 'Twitter', status: 'Live', color: 'bg-green-100 text-green-700' },
                                { name: 'Alipay', status: 'In Progress', color: 'bg-yellow-100 text-yellow-700' },
                                { name: 'Steam', status: 'Live', color: 'bg-green-100 text-green-700' },
                            ].map((item) => (
                                <div key={item.name} className="bg-white p-6 rounded-xl border border-gray-100 flex flex-col items-center gap-3 hover:shadow-md transition-shadow">
                                    <div className="w-12 h-12 bg-gray-50 rounded-full flex items-center justify-center">
                                        <LucideIcon name={item.name === 'GitHub' ? 'Github' : item.name === 'Twitter' ? 'Twitter' : 'Globe'} size={24} />
                                    </div>
                                    <span className="font-semibold">{item.name}</span>
                                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${item.color}`}>
                                        {item.status}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Page: Company ---

        const CompanyPage = () => {
            return (
                <div className="pt-32 pb-20 px-6 max-w-7xl mx-auto">
                    {/* Manifesto */}
                    <section className="text-center py-20 mb-20">
                        <h1 className="text-5xl md:text-8xl font-bold tracking-tight text-text mb-8">
                            Data is Property.
                        </h1>
                        <p className="text-xl md:text-2xl text-text-muted max-w-3xl mx-auto font-light">
                            We believe that in the digital age, privacy is not about secrecy, but about <span className="text-accent">control</span>.
                            GhostLink builds the bridge for true data ownership.
                        </p>
                    </section>

                    {/* Roadmap */}
                    <section className="max-w-2xl mx-auto">
                        <h3 className="text-xl font-bold mb-12 text-center">Master Plan</h3>
                        <div className="relative border-l-2 border-gray-100 ml-6 md:ml-0 space-y-16 pl-8 md:pl-12">
                            {[
                                { date: 'Q1 2026', title: 'MVP Launch', desc: 'GitHub Passport & Basic SDK release.', active: true },
                                { date: 'Q2 2026', title: 'SDK for dApps', desc: 'Plug-and-play components for React & Vue.', active: false },
                                { date: 'Q3 2026', title: 'Data Staking Economy', desc: 'Earn yield by verifying your own data.', active: false },
                            ].map((item, index) => (
                                <div key={index} className="relative group">
                                    <div className={`absolute -left-[41px] md:-left-[57px] top-1 w-4 h-4 rounded-full border-4 border-white ${item.active ? 'bg-accent shadow-[0_0_0_4px_rgba(59,130,246,0.1)]' : 'bg-gray-200'
                                        }`}></div>
                                    <span className="text-sm font-mono text-accent mb-1 block">{item.date}</span>
                                    <h4 className="text-xl font-bold mb-2">{item.title}</h4>
                                    <p className="text-text-muted">{item.desc}</p>
                                </div>
                            ))}
                        </div>
                    </section>
                </div>
            );
        };

        // --- Main App Controller ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [verificationStatus, setVerificationStatus] = useState('idle');
            const [userData, setUserData] = useState(null);
            const [zkProof, setZkProof] = useState(null);

            // Twitter State
            const [twitterStatus, setTwitterStatus] = useState('idle');
            const [twitterUser, setTwitterUser] = useState(null);
            const [twitterProof, setTwitterProof] = useState(null);

            // Wallet State
            const { account, signer, connectWallet, disconnectWallet, isConnecting } = useWallet();

            // Handle Popup Logic & Message Listener
            useEffect(() => {
                // 1. If we are the popup (child window)
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');

                if (code && window.opener) {
                    // Send code to parent
                    window.opener.postMessage({
                        type: state === 'twitter' ? 'TWITTER_AUTH_CODE' : 'GITHUB_AUTH_CODE',
                        code: code
                    }, window.location.origin);
                    // Close self
                    window.close();
                    return;
                }

                // 2. If we are the main window (parent)
                const handleMessage = (event) => {
                    if (event.origin !== window.location.origin) return;

                    if (event.data.type === 'GITHUB_AUTH_CODE') {
                        handleGithubCallback(event.data.code);
                    } else if (event.data.type === 'TWITTER_AUTH_CODE') {
                        handleTwitterCallback(event.data.code);
                    }
                };

                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, []);

            const handleGithubCallback = async (code) => {
                setActiveTab('solutions');
                setVerificationStatus('loading');

                // 获取当前钱包地址作为 recipient
                // 如果 account 状态还没有更新，尝试从 provider 获取
                let recipient = account;
                if (!recipient && window.ethereum) {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts && accounts.length > 0) {
                            recipient = accounts[0];
                        }
                    } catch (e) {
                        console.error('Failed to get accounts:', e);
                    }
                }

                if (!recipient) {
                    console.error("Wallet not connected. Please connect wallet first.");
                    setVerificationStatus('error');
                    alert('请先连接钱包！在点击 GitHub Connect 之前，请确保钱包已连接。');
                    return;
                }

                fetch('http://localhost:8080/api/v1/auth/github/callback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, recipient })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            console.error("Auth error:", data.error);
                            setVerificationStatus('error');
                        } else {
                            setUserData(data.user);
                            setZkProof(data.zkProof);
                            setVerificationStatus('success');
                        }
                    })
                    .catch(err => {
                        console.error("Network error:", err);
                        setVerificationStatus('error');
                    });
            };

            const handleTwitterCallback = async (code) => {
                setActiveTab('solutions');
                setTwitterStatus('loading');

                // Retrieve PKCE verifier from session storage
                const codeVerifier = sessionStorage.getItem('twitter_code_verifier');

                // 获取当前钱包地址作为 recipient
                // 如果 account 状态还没有更新，尝试从 provider 获取
                let recipient = account;
                if (!recipient && window.ethereum) {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts && accounts.length > 0) {
                            recipient = accounts[0];
                        }
                    } catch (e) {
                        console.error('Failed to get accounts:', e);
                    }
                }

                if (!recipient) {
                    console.error("Wallet not connected. Please connect wallet first.");
                    setTwitterStatus('error');
                    alert('请先连接钱包！在点击 Twitter Connect 之前，请确保钱包已连接。');
                    return;
                }

                fetch('http://localhost:8080/api/v1/auth/twitter/callback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code,
                        redirectUri: REDIRECT_URI,
                        codeVerifier: codeVerifier,
                        recipient: recipient
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) setTwitterStatus('error');
                        else { setTwitterUser(data.user); setTwitterProof(data.zkProof); setTwitterStatus('success'); }
                    })
                    .catch(() => setTwitterStatus('error'));
            };

            const onGithubConnect = async () => {
                // Auto-connect wallet if not connected
                let currentAccount = account;
                if (!currentAccount) {
                    const connected = await connectWallet();
                    if (!connected) {
                        return; // User cancelled or connection failed
                    }
                    // Wait for state update and get the actual account
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Try to get account from ethereum provider directly
                    if (window.ethereum) {
                        try {
                            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                            if (accounts && accounts.length > 0) {
                                currentAccount = accounts[0];
                                console.log('Wallet connected:', currentAccount);
                            }
                        } catch (e) {
                            console.error('Failed to get accounts:', e);
                        }
                    }

                    if (!currentAccount) {
                        alert('Failed to connect wallet. Please try again.');
                        return;
                    }
                }

                if (!GITHUB_CLIENT_ID) {
                    alert("Configuration error: please set your GitHub Client ID in index.html.");
                    return;
                }
                const authUrl = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=read:user`;
                // Open popup
                const width = 600;
                const height = 700;
                const left = (window.screen.width - width) / 2;
                const top = (window.screen.height - height) / 2;
                window.open(authUrl, 'GitHub Auth', `width=${width},height=${height},top=${top},left=${left}`);
            };

            const onTwitterConnect = async () => {
                // Auto-connect wallet if not connected
                let currentAccount = account;
                if (!currentAccount) {
                    const connected = await connectWallet();
                    if (!connected) {
                        return; // User cancelled or connection failed
                    }
                    // Wait for state update and get the actual account
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Try to get account from ethereum provider directly
                    if (window.ethereum) {
                        try {
                            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                            if (accounts && accounts.length > 0) {
                                currentAccount = accounts[0];
                                console.log('Wallet connected:', currentAccount);
                            }
                        } catch (e) {
                            console.error('Failed to get accounts:', e);
                        }
                    }

                    if (!currentAccount) {
                        alert('Failed to connect wallet. Please try again.');
                        return;
                    }
                }

                if (!TWITTER_CLIENT_ID) { alert("Configuration error: please set TWITTER_CLIENT_ID."); return; }

                // Twitter OAuth 2.0 PKCE Flow
                // Simple random string generator for demo
                const generateRandomString = (length) => {
                    const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
                    let result = '';
                    for (let i = 0; i < length; i++) {
                        result += charset.charAt(Math.floor(Math.random() * charset.length));
                    }
                    return result;
                };

                // Simple SHA256 for demo (in production use crypto.subtle)
                const sha256 = async (plain) => {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(plain);
                    return window.crypto.subtle.digest('SHA-256', data);
                };

                const base64urlencode = (a) => {
                    return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
                        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
                };

                const codeVerifier = generateRandomString(64);
                sessionStorage.setItem('twitter_code_verifier', codeVerifier);

                const codeChallengeBuffer = await sha256(codeVerifier);
                const codeChallenge = base64urlencode(codeChallengeBuffer);

                const authUrl = `https://twitter.com/i/oauth2/authorize?response_type=code&client_id=${TWITTER_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=users.read%20tweet.read&state=twitter&code_challenge=${codeChallenge}&code_challenge_method=S256`;

                window.open(authUrl, 'Twitter Auth', 'width=600,height=700');
            };

            const renderContent = () => {
                switch (activeTab) {
                    case 'solutions':
                        return <SolutionsPage
                            initialVerificationStatus={verificationStatus}
                            initialUserData={userData}
                            initialZkProof={zkProof}
                            onGithubConnect={onGithubConnect}
                            twitterStatus={twitterStatus}
                            twitterUser={twitterUser}
                            twitterProof={twitterProof}
                            onTwitterConnect={onTwitterConnect}
                            walletAccount={account}
                            walletSigner={signer}
                        />;
                    case 'developers': return <DevelopersPage />;
                    case 'company': return <CompanyPage />;
                    default: return <HomePage />;
                }
            };

            return (
                <div className="min-h-screen bg-bg">
                    <Navbar
                        activeTab={activeTab}
                        setActiveTab={setActiveTab}
                        account={account}
                        connectWallet={connectWallet}
                        disconnectWallet={disconnectWallet}
                        isConnecting={isConnecting}
                    />

                    <AnimatePresence mode="wait">
                        <motion.main
                            key={activeTab}
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, y: -10 }}
                            transition={{ duration: 0.3 }}
                        >
                            {renderContent()}
                        </motion.main>
                    </AnimatePresence>

                    <Footer />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>