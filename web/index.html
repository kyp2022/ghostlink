<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostLink | Invisible Tech, Visible Trust</title>

    <!-- Fonts: Inter (Variable) & SF Pro Display simulation -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Ethers.js for Ethereum interaction -->
    <!-- 使用多个CDN源以确保加载成功 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" 
            onerror="console.error('Failed to load ethers.js from jsdelivr'); this.onerror=null; this.src='https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';">
    </script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: {
                            DEFAULT: '#F5F5F7', // Off-white
                            surface: '#FFFFFF', // Ceramic White
                        },
                        text: {
                            DEFAULT: '#111111', // Ink Black
                            muted: '#6B7280',   // Cool Grey
                        },
                        accent: {
                            DEFAULT: '#3B82F6', // Holographic Blue
                            dark: '#2563EB',
                        },
                        border: {
                            DEFAULT: '#E5E7EB',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'glass': '0 4px 30px rgba(0, 0, 0, 0.05)',
                        'prism': '0 20px 40px -10px rgba(59, 130, 246, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F5F5F7;
            color: #111111;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Optical Glass Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        /* Prism Gradient */
        .prism-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(59,130,246,0.1) 50%, rgba(255,255,255,0.4) 100%);
        }

        /* Rainbow sheen for hologram */
        .hologram-text {
            background: linear-gradient(90deg, #111 0%, #3B82F6 50%, #111 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 5s linear infinite;
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    // 检查必要的库是否已加载
    if (typeof React === 'undefined') {
        console.error('React is not loaded');
        document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>加载错误</h1><p>React 库未加载，请刷新页面重试</p></div>';
    }
    
    if (typeof ethers === 'undefined') {
        console.warn('ethers.js is not loaded yet. Some features may not work.');
        // 不阻止页面加载，但会在使用时检查
    }

    const { useState, useEffect } = React;
    const { motion, AnimatePresence } = window.Motion;

    // --- CONFIGURATION ---
    const GITHUB_CLIENT_ID = "Iv23li88rvwnNxTsjlfc";
    const TWITTER_CLIENT_ID = "Y2ZMMWgzOGNNYjdISDhVZ1BHNjc6MTpjaQ";

    // The redirect URI must match what you configured in GitHub App settings
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    // Contract Configuration
    const CONTRACT_ADDRESS = "0x9400bd507276582aA9f33fd84B836FD4b30fed39";
    // 测试网RPC (Sepolia测试网示例，根据实际部署的网络修改)
    const RPC_URL = "https://sepolia.infura.io/v3/YOUR_INFURA_KEY"; // 或使用公共RPC
    const CHAIN_ID = 11155111; // Sepolia测试网，根据实际网络修改

    // 合约ABI (根据实际部署的合约接口调整)
    // 注意：如果实际合约接口参数不同，需要修改以下ABI和mintCredential函数中的调用方式
    // 参考 demo/contract-call-example.js 中的示例
    const CONTRACT_ABI = [
        "function verifyAndMint(bytes calldata receipt, bytes32 journal, uint8 credentialType) external",
        "function hasCredential(address user, uint8 credentialType) external view returns (bool)",
        "event CredentialMinted(address indexed user, uint8 credentialType, bytes32 nullifier)"
    ];

    // --- Helper: 等待 ethers.js 加载 ---
    const waitForEthers = () => {
        return new Promise((resolve, reject) => {
            if (typeof ethers !== 'undefined') {
                resolve(ethers);
                return;
            }
            
            // 等待最多5秒
            let attempts = 0;
            const maxAttempts = 50; // 5秒 = 50 * 100ms
            const checkInterval = setInterval(() => {
                attempts++;
                if (typeof ethers !== 'undefined') {
                    clearInterval(checkInterval);
                    resolve(ethers);
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    reject(new Error('ethers.js 加载超时，请刷新页面重试'));
                }
            }, 100);
        });
    };

    // --- Icons Wrapper ---
    const LucideIcon = ({ name, size = 20, className, ...props }) => {
        const iconDef = window.lucide.icons[name];
        if (!iconDef) return null;
        return (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {iconDef.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
            </svg>
        );
    };

    // --- Wallet Connection Hook ---
    const useWallet = () => {
        const [account, setAccount] = useState(null);
        const [provider, setProvider] = useState(null);
        const [signer, setSigner] = useState(null);
        const [isConnecting, setIsConnecting] = useState(false);

        const connectWallet = async () => {
            // 等待 ethers.js 加载
            try {
                await waitForEthers();
            } catch (error) {
                alert('Ethers.js 库加载失败，请刷新页面重试');
                console.error('ethers.js loading error:', error);
                return false;
            }

            if (typeof window.ethereum === 'undefined') {
                alert('请安装 MetaMask 钱包扩展');
                return false;
            }

            setIsConnecting(true);
            try {
                // 请求账户访问
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length === 0) {
                    throw new Error('未授权账户访问');
                }

                // 检查网络
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const targetChainId = '0x' + CHAIN_ID.toString(16);

                if (chainId !== targetChainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: targetChainId }],
                        });
                    } catch (switchError) {
                        // 如果网络不存在，尝试添加
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: targetChainId,
                                    chainName: 'Sepolia Testnet',
                                    rpcUrls: ['https://sepolia.infura.io/v3/'],
                                    nativeCurrency: {
                                        name: 'ETH',
                                        symbol: 'ETH',
                                        decimals: 18
                                    }
                                }],
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }

                // 使用全局 ethers 对象
                const ethersProvider = new ethers.providers.Web3Provider(window.ethereum);
                const ethersSigner = ethersProvider.getSigner();

                setAccount(accounts[0]);
                setProvider(ethersProvider);
                setSigner(ethersSigner);

                // 监听账户变化
                window.ethereum.on('accountsChanged', (newAccounts) => {
                    if (newAccounts.length === 0) {
                        setAccount(null);
                        setProvider(null);
                        setSigner(null);
                    } else {
                        setAccount(newAccounts[0]);
                        const newProvider = new ethers.providers.Web3Provider(window.ethereum);
                        setProvider(newProvider);
                        setSigner(newProvider.getSigner());
                    }
                });

                // 监听网络变化
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });

                return true;
            } catch (error) {
                console.error('连接钱包失败:', error);
                alert('连接钱包失败: ' + error.message);
                return false;
            } finally {
                setIsConnecting(false);
            }
        };

        return { account, provider, signer, isConnecting, connectWallet };
    };

    // --- Wallet Button Component ---
    const WalletButton = () => {
        const { account, connectWallet, isConnecting } = useWallet();

        const formatAddress = (addr) => {
            if (!addr) return '';
            return `${addr.substring(0, 6)}...${addr.substring(addr.length - 4)}`;
        };

        if (account) {
            return (
                <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm">
                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span className="text-sm font-mono">{formatAddress(account)}</span>
                </div>
            );
        }

        return (
            <button
                onClick={connectWallet}
                disabled={isConnecting}
                className="bg-black text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-gray-900 transition-colors shadow-lg shadow-black/10 disabled:opacity-50"
            >
                {isConnecting ? '连接中...' : 'Connect Wallet'}
            </button>
        );
    };

    // --- Layout Components ---

    const Navbar = ({ activeTab, setActiveTab }) => {
        const tabs = [
            { id: 'home', label: 'Home' },
            { id: 'solutions', label: 'Solutions' },
            { id: 'developers', label: 'Developers' },
            { id: 'company', label: 'Company' },
        ];

        return (
            <nav className="fixed top-0 left-0 right-0 z-50 h-16 glass-panel border-b border-white/20">
                <div className="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
                    <div
                        className="flex items-center gap-2 cursor-pointer"
                        onClick={() => setActiveTab('home')}
                    >
                        <div className="w-8 h-8 bg-black rounded-lg flex items-center justify-center text-white">
                            <LucideIcon name="Ghost" size={18} />
                        </div>
                        <span className="font-semibold text-lg tracking-tight">GhostLink</span>
                    </div>

                    <div className="hidden md:flex items-center gap-1 bg-gray-100/50 p-1 rounded-full">
                        {tabs.map((tab) => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-300 ${
                                    activeTab === tab.id
                                        ? 'bg-white text-black shadow-sm'
                                        : 'text-text-muted hover:text-black'
                                }`}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    <WalletButton />
                </div>
            </nav>
        );
    };

    const Footer = () => (
        <footer className="bg-white border-t border-gray-100 py-12 mt-20">
            <div className="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-4 gap-8">
                <div className="col-span-1">
                    <div className="flex items-center gap-2 mb-4">
                        <div className="w-6 h-6 bg-black rounded flex items-center justify-center text-white">
                            <LucideIcon name="Ghost" size={14} />
                        </div>
                        <span className="font-bold">GhostLink</span>
                    </div>
                    <p className="text-sm text-text-muted">© 2026 GhostLink Labs.</p>
                </div>
                {['Product', 'Resources', 'Company'].map((col) => (
                    <div key={col}>
                        <h4 className="font-semibold mb-4 text-sm">{col}</h4>
                        <ul className="space-y-2 text-sm text-text-muted">
                            <li>Overview</li>
                            <li>Documentation</li>
                            <li>Status</li>
                        </ul>
                    </div>
                ))}
            </div>
        </footer>
    );

    // --- Page: Home ---

    const GlassPrismHero = () => {
        return (
            <div className="relative h-[600px] w-full flex items-center justify-center bg-[#F0F2F5] rounded-3xl overflow-hidden border border-white">
                {/* Background Grid */}
                <div className="absolute inset-0"
                     style={{ backgroundImage: 'radial-gradient(#CBD5E1 1px, transparent 1px)', backgroundSize: '32px 32px', opacity: 0.5 }}>
                </div>

                <div className="relative z-10 flex items-center gap-12 scale-90 md:scale-100">
                    {/* 1. Raw Input (Blurred Paper) */}
                    <motion.div
                        animate={{ x: [0, 150, 300], opacity: [0, 1, 0], scale: [0.8, 1, 0.8] }}
                        transition={{ duration: 4, repeat: Infinity, ease: "easeInOut" }}
                        className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-full z-0"
                    >
                        <div className="w-24 h-32 bg-white rounded shadow-sm border border-gray-200 p-2 flex flex-col gap-2 blur-[2px] opacity-70">
                            <div className="h-2 w-16 bg-gray-200 rounded"></div>
                            <div className="h-2 w-full bg-gray-100 rounded"></div>
                            <div className="h-2 w-full bg-gray-100 rounded"></div>
                            <div className="h-12 w-full bg-gray-50 rounded mt-auto"></div>
                        </div>
                        <div className="mt-4 text-center text-xs font-mono text-gray-400">Raw Data</div>
                    </motion.div>

                    {/* 2. The Prism (RISC Zero) */}
                    <div className="relative w-48 h-48 z-10">
                        {/* Glass Shape */}
                        <div className="absolute inset-0 bg-gradient-to-br from-white/80 to-blue-50/20 backdrop-blur-xl border border-white/60 rounded-[30px] shadow-prism transform rotate-45 flex items-center justify-center">
                            <div className="transform -rotate-45 text-accent opacity-50">
                                <LucideIcon name="Cpu" size={48} strokeWidth={1} />
                            </div>
                        </div>
                        {/* Light Refraction */}
                        <div className="absolute inset-0 bg-white/30 rounded-[30px] rotate-45 animate-pulse mix-blend-overlay"></div>
                        <div className="absolute -bottom-12 left-1/2 -translate-x-1/2 font-mono text-xs text-accent font-medium tracking-wider bg-white px-2 py-1 rounded shadow-sm">
                            ZK_CIRCUIT
                        </div>
                    </div>

                    {/* 3. Output (Gold Coin) */}
                    <motion.div
                        animate={{ x: [-100, 100], opacity: [0, 0, 1, 0] }}
                        transition={{ duration: 4, repeat: Infinity, times: [0, 0.6, 0.8, 1] }}
                        className="absolute right-0 top-1/2 -translate-y-1/2 z-0"
                    >
                        <div className="w-20 h-20 bg-gradient-to-br from-yellow-200 to-yellow-500 rounded-full shadow-lg flex items-center justify-center border-4 border-white">
                            <div className="w-12 h-12 border-2 border-yellow-100/50 rounded-full flex items-center justify-center text-white font-bold text-xl">
                                GL
                            </div>
                        </div>
                        <div className="mt-4 text-center text-xs font-mono text-gray-800 font-bold">Proof Asset</div>
                    </motion.div>
                </div>
            </div>
        );
    };

    const HomePage = () => {
        return (
            <div className="space-y-24 pb-20">
                {/* Hero Section */}
                <section className="pt-32 px-6 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
                    <div className="space-y-8">
                        <motion.div
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="inline-flex items-center gap-2 px-3 py-1 bg-white border border-gray-200 rounded-full text-xs font-medium text-text-muted shadow-sm"
                        >
                            <span className="w-2 h-2 bg-accent rounded-full animate-pulse"></span>
                            Now Live on Mainnet
                        </motion.div>
                        <motion.h1
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ delay: 0.1 }}
                            className="text-5xl md:text-7xl font-bold tracking-tight leading-[1.1] text-text"
                        >
                            Prove it’s you, <br/>
                            <span className="text-text-muted">without revealing who you are.</span>
                        </motion.h1>
                        <motion.p
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            transition={{ delay: 0.2 }}
                            className="text-xl text-text-muted max-w-md leading-relaxed"
                        >
                            GhostLink turns your GitHub, PayPal, and Uber history into on-chain reputation badges.
                            <span className="text-text font-medium"> Private. Verifiable. Built on RISC Zero.</span>
                        </motion.p>
                        <motion.div
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            transition={{ delay: 0.3 }}
                            className="flex items-center gap-4"
                        >
                            <button className="px-8 py-4 bg-text text-white rounded-xl font-medium hover:bg-black/80 transition-all shadow-lg shadow-black/10">
                                Connect Wallet
                            </button>
                            <button className="px-8 py-4 bg-white border border-gray-200 text-text rounded-xl font-medium hover:bg-gray-50 transition-all">
                                View Demo
                            </button>
                        </motion.div>
                    </div>

                    <div className="relative">
                        <GlassPrismHero />
                    </div>
                </section>

                {/* Architecture Section */}
                <section className="px-6 max-w-7xl mx-auto">
                    <div className="bg-white rounded-3xl p-16 border border-gray-100 shadow-sm relative overflow-hidden">
                        <div className="absolute inset-0 pointer-events-none opacity-[0.03]"
                             style={{ backgroundImage: 'linear-gradient(90deg, #000 1px, transparent 1px)', backgroundSize: '40px 100%' }}>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-12 relative z-10">
                            {/* Step 1 */}
                            <div className="flex flex-col items-center text-center space-y-4 group">
                                <div className="w-20 h-20 bg-[#F5F5F7] rounded-2xl flex items-center justify-center mb-4 group-hover:scale-105 transition-transform duration-500">
                                    <LucideIcon name="Smartphone" size={32} className="text-gray-400 group-hover:text-black transition-colors" />
                                </div>
                                <h3 className="font-semibold text-lg">User Local</h3>
                                <p className="text-sm text-text-muted">Data stays on your device.<br/>TLS encryption intact.</p>
                            </div>
                            {/* Step 2 */}
                            <div className="flex flex-col items-center text-center space-y-4 group">
                                <div className="w-20 h-20 bg-white border border-blue-100 shadow-prism rounded-2xl flex items-center justify-center mb-4 relative overflow-hidden">
                                    <div className="absolute inset-0 bg-blue-50/50"></div>
                                    <LucideIcon name="Cpu" size={32} className="text-accent relative z-10" />
                                </div>
                                <h3 className="font-semibold text-lg text-accent">ZK Processor</h3>
                                <p className="text-sm text-text-muted">Mathematical Proof generated<br/>in isolated environment.</p>
                            </div>
                            {/* Step 3 */}
                            <div className="flex flex-col items-center text-center space-y-4 group">
                                <div className="w-20 h-20 bg-[#F5F5F7] rounded-2xl flex items-center justify-center mb-4 group-hover:scale-105 transition-transform duration-500">
                                    <LucideIcon name="Blocks" size={32} className="text-gray-400 group-hover:text-black transition-colors" />
                                </div>
                                <h3 className="font-semibold text-lg">Blockchain</h3>
                                <p className="text-sm text-text-muted">Public Verification.<br/>Smart Contract composability.</p>
                            </div>
                        </div>

                        {/* Connecting Line with flowing dot */}
                        <div className="absolute top-[35%] left-[16%] right-[16%] h-[2px] bg-gray-100 -z-10 hidden md:block">
                            <motion.div
                                animate={{ x: ['0%', '100%'], opacity: [0, 1, 0] }}
                                transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}
                                className="w-20 h-full bg-gradient-to-r from-transparent via-accent to-transparent"
                            />
                        </div>
                    </div>
                </section>

                {/* Trust Battery */}
                <section className="text-center pb-20">
                    <p className="text-sm font-semibold tracking-wide text-text-muted uppercase mb-8">Trusted Infrastructure</p>
                    <div className="flex flex-wrap justify-center gap-12 opacity-50 grayscale hover:grayscale-0 transition-all duration-500">
                        {/* Simple text placeholders for logos to maintain clean code */}
                        <span className="text-xl font-bold font-mono">RISC ZERO</span>
                        <span className="text-xl font-bold font-mono">ETHEREAL</span>
                        <span className="text-xl font-bold font-mono">TLSNotary</span>
                        <span className="text-xl font-bold font-mono">StarkWare</span>
                    </div>
                </section>
            </div>
        );
    };

    // --- Progress Modal Component ---
    const ProgressModal = ({ isOpen, onClose, steps, currentStep }) => {
        if (!isOpen) return null;

        const stepStatus = (stepIndex) => {
            if (stepIndex < currentStep) return 'completed';
            if (stepIndex === currentStep) return 'active';
            return 'pending';
        };

        const getStepIcon = (status) => {
            if (status === 'completed') {
                return <LucideIcon name="Check" size={20} className="text-green-600" />;
            }
            if (status === 'active') {
                return <div className="w-5 h-5 border-2 border-accent border-t-transparent rounded-full animate-spin"></div>;
            }
            return <div className="w-5 h-5 border-2 border-gray-300 rounded-full"></div>;
        };

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
                <motion.div
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4"
                >
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-xl font-bold">上链进度</h3>
                        {currentStep >= steps.length - 1 && (
                            <button
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 transition-colors"
                            >
                                <LucideIcon name="X" size={20} />
                            </button>
                        )}
                    </div>

                    <div className="space-y-4">
                        {steps.map((step, index) => {
                            const status = stepStatus(index);
                            return (
                                <div
                                    key={index}
                                    className={`flex items-center gap-4 p-4 rounded-lg transition-all ${
                                        status === 'active' ? 'bg-blue-50 border-2 border-accent' :
                                        status === 'completed' ? 'bg-green-50 border-2 border-green-200' :
                                        'bg-gray-50 border-2 border-gray-200'
                                    }`}
                                >
                                    <div className="flex-shrink-0">
                                        {getStepIcon(status)}
                                    </div>
                                    <div className="flex-1">
                                        <div className={`font-medium ${
                                            status === 'active' ? 'text-accent' :
                                            status === 'completed' ? 'text-green-700' :
                                            'text-gray-500'
                                        }`}>
                                            {step.title}
                                        </div>
                                        {step.description && (
                                            <div className="text-sm text-gray-500 mt-1">
                                                {step.description}
                                            </div>
                                        )}
                                        {step.details && (status === 'active' || status === 'completed') && (
                                            <div className={`text-xs mt-2 font-mono break-all ${
                                                status === 'completed' ? 'text-green-600' : 'text-gray-600'
                                            }`}>
                                                {step.details}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {currentStep >= steps.length - 1 && (
                        <motion.div
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="mt-6 pt-6 border-t border-gray-200"
                        >
                            <button
                                onClick={onClose}
                                className="w-full bg-accent text-white py-3 rounded-lg font-medium hover:bg-accent-dark transition-colors"
                            >
                                完成
                            </button>
                        </motion.div>
                    )}
                </motion.div>
            </div>
        );
    };

    // --- Contract Interaction Functions ---
    const useContract = (signer, account) => {
        const [isMinting, setIsMinting] = useState(false);
        const [mintStatus, setMintStatus] = useState(null);
        const [progressSteps, setProgressSteps] = useState([]);
        const [currentProgressStep, setCurrentProgressStep] = useState(0);
        const [showProgressModal, setShowProgressModal] = useState(false);

        const mintCredential = async (zkProof, credentialType, autoStart = false) => {
            // 等待 ethers.js 加载
            try {
                await waitForEthers();
            } catch (error) {
                alert('Ethers.js 库加载失败，请刷新页面重试');
                console.error('ethers.js loading error:', error);
                return false;
            }

            if (!signer || !account) {
                alert('请先连接钱包');
                return false;
            }

            if (!zkProof) {
                alert('缺少零知识证明数据');
                return false;
            }

            setIsMinting(true);
            
            console.log('mintCredential 被调用', { zkProof, credentialType, autoStart });
            
            // 初始化进度步骤
            const steps = [
                { title: '生成零知识证明', description: '正在生成证明数据...' },
                { title: '准备上链交易', description: '准备交易参数...' },
                { title: '提交交易', description: '等待用户确认...' },
                { title: '等待确认', description: '交易已提交，等待区块确认...' },
                { title: '完成', description: '凭证已成功铸造！' }
            ];
            setProgressSteps(steps);
            setCurrentProgressStep(0);
            if (autoStart) {
                console.log('显示进度弹窗');
                setShowProgressModal(true);
            }

            try {
                // 步骤1: 生成证明（如果还没有）
                setCurrentProgressStep(0);
                setProgressSteps(prev => prev.map((s, i) => 
                    i === 0 ? { ...s, description: '证明已生成', details: `Proof ID: ${zkProof.proofId || 'N/A'}` } : s
                ));
                
                // 模拟生成证明的延迟（实际应该调用ZK服务）
                await new Promise(resolve => setTimeout(resolve, 800));

                // 步骤2: 准备交易
                setCurrentProgressStep(1);
                setProgressSteps(prev => prev.map((s, i) => 
                    i === 1 ? { ...s, description: '交易参数已准备' } : s
                ));

                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // ===== 根据实际合约接口调整以下参数 =====
                // 当前假设合约接口：verifyAndMint(bytes receipt, bytes32 journal, uint8 credentialType)
                // 如果实际合约接口不同，请参考 demo/contract-call-example.js 中的示例进行修改
                
                let receipt, journal;
                
                if (zkProof.receipt) {
                    // receipt应该是bytes格式
                    receipt = typeof zkProof.receipt === 'string' 
                        ? zkProof.receipt.startsWith('0x')
                            ? zkProof.receipt
                            : '0x' + zkProof.receipt
                        : ethers.utils.hexlify(zkProof.receipt);
                } else {
                    // Mock数据：实际应该从后端获取真实的receipt
                    receipt = '0x00';
                }

                if (zkProof.journal) {
                    // journal应该是bytes32格式（64个十六进制字符，带0x前缀）
                    journal = typeof zkProof.journal === 'string' 
                        ? zkProof.journal.startsWith('0x') 
                            ? zkProof.journal 
                            : '0x' + zkProof.journal
                        : zkProof.journal;
                    // 确保journal是有效的bytes32（66个字符：0x + 64个hex字符）
                    // 如果长度不对，尝试补齐或截断
                    if (journal.length < 66) {
                        // 如果长度不够，前面补0（去掉0x后补）
                        const hexPart = journal.substring(2);
                        const padding = '0'.repeat(64 - hexPart.length);
                        journal = '0x' + padding + hexPart;
                    } else if (journal.length > 66) {
                        // 如果长度超过，截取前66个字符
                        journal = journal.substring(0, 66);
                    }
                    console.log('Journal处理后的长度:', journal.length, '内容:', journal.substring(0, 20) + '...');
                } else {
                    // Mock数据：实际应该从后端获取真实的journal
                    journal = ethers.constants.HashZero;
                }

                const credType = credentialType || 0; // 0: GitHub, 1: Twitter

                // 步骤3: 提交交易
                setCurrentProgressStep(2);
                setProgressSteps(prev => prev.map((s, i) => 
                    i === 2 ? { ...s, description: '请在MetaMask中确认交易' } : s
                ));

                setMintStatus({ type: 'pending', message: '等待用户确认交易...' });

                console.log('准备调用合约，参数:', { 
                    receipt: receipt.substring(0, 20) + '...', 
                    journal, 
                    credType,
                    contractAddress: CONTRACT_ADDRESS
                });

                // 调用合约方法，添加gas limit设置
                // 如果合约接口参数不同，请修改这里的调用方式
                // 例如：如果合约需要imageId，可以添加：contract.verifyAndMint(receipt, journal, zkProof.imageId, credType)
                
                // 估算gas，如果失败则使用固定值
                let gasEstimate;
                try {
                    gasEstimate = await contract.estimateGas.verifyAndMint(receipt, journal, credType);
                    console.log('Gas估算成功:', gasEstimate.toString());
                } catch (estimateError) {
                    console.warn('Gas估算失败，使用固定值:', estimateError.message);
                    // 使用一个较大的固定gas limit（根据实际合约调整）
                    gasEstimate = ethers.BigNumber.from('500000'); // 500k gas
                }
                
                // 调用合约，设置gas limit
                const tx = await contract.verifyAndMint(receipt, journal, credType, {
                    gasLimit: gasEstimate.mul(120).div(100) // 增加20%的gas buffer
                });
                
                // 步骤4: 等待确认
                setCurrentProgressStep(3);
                setProgressSteps(prev => prev.map((s, i) => 
                    i === 3 ? { 
                        ...s, 
                        description: '交易已提交，等待区块确认...',
                        details: `交易哈希: ${tx.hash.substring(0, 10)}...`
                    } : s
                ));
                
                setMintStatus({ type: 'pending', message: '交易已提交，等待确认...', txHash: tx.hash });

                // 等待交易确认
                const receipt_tx = await tx.wait();
                
                // 步骤5: 完成
                setCurrentProgressStep(4);
                setProgressSteps(prev => prev.map((s, i) => 
                    i === 4 ? { 
                        ...s, 
                        description: '凭证已成功铸造！',
                        details: `区块: ${receipt_tx.blockNumber}`
                    } : s
                ));
                
                setMintStatus({ 
                    type: 'success', 
                    message: '凭证已成功铸造！', 
                    txHash: receipt_tx.transactionHash 
                });

                return true;
            } catch (error) {
                console.error('上链失败:', error);
                let errorMessage = '上链失败';
                if (error.code === 4001) {
                    errorMessage = '用户拒绝了交易';
                    setCurrentProgressStep(-1); // 重置进度
                } else if (error.message) {
                    errorMessage = error.message;
                }
                setMintStatus({ type: 'error', message: errorMessage });
                setProgressSteps(prev => prev.map((s, i) => 
                    i === currentProgressStep ? { ...s, description: `失败: ${errorMessage}` } : s
                ));
                return false;
            } finally {
                setIsMinting(false);
            }
        };

        return { 
            mintCredential, 
            isMinting, 
            mintStatus, 
            progressSteps, 
            currentProgressStep, 
            showProgressModal, 
            setShowProgressModal 
        };
    };

    // --- Page: Solutions ---

    const SolutionsPage = ({
        initialVerificationStatus, initialUserData, initialZkProof, onGithubConnect,
        twitterStatus, twitterUser, twitterProof, onTwitterConnect,
        walletAccount, walletSigner
    }) => {
        const [activeTab, setActiveTab] = useState('identity');
        // 使用传入的钱包信息，如果没有则使用 useWallet hook
        const walletHook = useWallet();
        const account = walletAccount || walletHook.account;
        const signer = walletSigner || walletHook.signer;
        
        const { 
            mintCredential, 
            isMinting, 
            mintStatus, 
            progressSteps, 
            currentProgressStep, 
            showProgressModal, 
            setShowProgressModal 
        } = useContract(signer, account);

        // 当授权成功且有钱包连接时，自动触发上链
        const githubAutoMintedRef = React.useRef(false);
        const twitterAutoMintedRef = React.useRef(false);

        useEffect(() => {
            if (initialVerificationStatus === 'success' && account && initialZkProof && !isMinting && !githubAutoMintedRef.current) {
                githubAutoMintedRef.current = true;
                console.log('GitHub验证成功，准备自动上链...', { account, zkProof: initialZkProof });
                // 延迟一下，让用户看到验证成功的状态
                const timer = setTimeout(() => {
                    console.log('开始自动上链...');
                    mintCredential(initialZkProof, 0, true); // autoStart = true
                }, 1500);
                return () => clearTimeout(timer);
            }
        }, [initialVerificationStatus, account, initialZkProof, isMinting]);

        useEffect(() => {
            if (twitterStatus === 'success' && account && twitterProof && !isMinting && !twitterAutoMintedRef.current) {
                twitterAutoMintedRef.current = true;
                console.log('Twitter验证成功，准备自动上链...', { account, zkProof: twitterProof });
                const timer = setTimeout(() => {
                    console.log('开始自动上链...');
                    mintCredential(twitterProof, 1, true); // autoStart = true
                }, 1500);
                return () => clearTimeout(timer);
            }
        }, [twitterStatus, account, twitterProof, isMinting]);

        const tabContent = {
            defi: {
                title: "Enable under-collateralized loans.",
                desc: "Import off-chain credit history from PayPal or Stripe to prove solvency without revealing transactions.",
                mockup: (
                    <div className="bg-white rounded-xl shadow-lg border border-gray-100 p-6 h-full flex flex-col">
                        <div className="flex justify-between items-center mb-8 border-b border-gray-100 pb-4">
                            <div className="font-bold">Aave Loan Market</div>
                            <div className="bg-gray-100 px-3 py-1 rounded-full text-xs">Wallet Connected</div>
                        </div>
                        <div className="space-y-4">
                            <div className="p-4 bg-blue-50 border border-blue-100 rounded-lg flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-accent">
                                        <LucideIcon name="ShieldCheck" size={16} />
                                    </div>
                                    <div>
                                        <div className="text-sm font-bold text-gray-900">GhostLink Score</div>
                                        <div className="text-xs text-gray-500">Source: PayPal</div>
                                    </div>
                                </div>
                                <div className="text-lg font-bold text-accent">780</div>
                            </div>
                            <div className="space-y-2">
                                <div className="flex justify-between text-sm">
                                    <span className="text-gray-500">Max LTV</span>
                                    <span className="font-medium text-green-600">85% (Boosted)</span>
                                </div>
                                <div className="w-full bg-gray-100 rounded-full h-2">
                                    <div className="w-[85%] bg-green-500 h-2 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            },
            growth: {
                title: "Stop bots. Reward humans.",
                desc: "Verify users based on real-world spending power (e.g. Uber rides > 5) to prevent Sybil attacks.",
                mockup: (
                    <div className="bg-white rounded-xl shadow-lg border border-gray-100 p-6 h-full flex flex-col">
                        <div className="text-center mb-8">
                            <div className="w-12 h-12 bg-black rounded-full mx-auto mb-2"></div>
                            <div className="font-bold">Exclusive Airdrop</div>
                        </div>
                        <button className="w-full py-3 bg-gray-100 text-gray-400 rounded-lg font-medium cursor-not-allowed mb-3">
                            Claim Tokens (Locked)
                        </button>
                        <button className="w-full py-3 bg-black text-white rounded-lg font-medium flex items-center justify-center gap-2">
                            <LucideIcon name="Car" size={16} />
                            Verify Uber History
                        </button>
                        <p className="text-center text-xs text-green-600 mt-2 flex items-center justify-center gap-1">
                            <LucideIcon name="Check" size={12} />
                            Requirement: 5+ Rides
                        </p>
                    </div>
                )
            },
            identity: {
                title: "One Person, One ID.",
                desc: "Link multiple Web2 accounts (Twitter, GitHub, Email) to create a robust, private on-chain identity.",
                mockup: (
                    <div className="bg-white rounded-xl shadow-lg border border-gray-100 p-6 h-full flex flex-col">
                        <div className="font-bold mb-6">My Identity Orb</div>
                        <div className="space-y-3">
                            {/* GitHub Item */}
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div className="flex items-center gap-3">
                                    <LucideIcon name="Github" size={18} />
                                    <span className="text-sm">GitHub</span>
                                </div>
                                {initialVerificationStatus === 'success' ? (
                                     <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded flex items-center gap-1">
                                        <LucideIcon name="Check" size={10} /> Verified
                                     </span>
                                ) : (
                                    <button
                                        onClick={onGithubConnect}
                                        disabled={initialVerificationStatus === 'loading'}
                                        className="text-xs bg-black text-white px-3 py-1.5 rounded hover:bg-gray-800 transition-colors"
                                    >
                                        {initialVerificationStatus === 'loading' ? 'Verifying...' : 'Connect'}
                                    </button>
                                )}
                            </div>

                            {/* Success Details */}
                            {initialVerificationStatus === 'success' && (
                                <motion.div
                                    initial={{ height: 0, opacity: 0 }}
                                    animate={{ height: 'auto', opacity: 1 }}
                                    className="space-y-2"
                                >
                                    <div className="text-xs bg-green-50 p-2 rounded border border-green-100 text-green-800">
                                        <p><strong>User:</strong> {initialUserData?.login}</p>
                                        <p><strong>ZK Proof:</strong> {initialZkProof?.proofId}</p>
                                    </div>
                                    {account && (
                                        <button
                                            onClick={() => mintCredential(initialZkProof, 0)}
                                            disabled={isMinting}
                                            className="w-full text-xs bg-accent text-white px-3 py-2 rounded hover:bg-accent-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                        >
                                            {isMinting ? (
                                                <>
                                                    <div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                    <span>上链中...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <LucideIcon name="Upload" size={12} />
                                                    <span>上链铸造凭证</span>
                                                </>
                                            )}
                                        </button>
                                    )}
                                    {!account && (
                                        <div className="text-xs text-gray-500 text-center py-1">
                                            连接钱包后可上链
                                        </div>
                                    )}
                                    {mintStatus && (
                                        <div className={`text-xs p-2 rounded ${
                                            mintStatus.type === 'success' 
                                                ? 'bg-green-50 text-green-800 border border-green-100' 
                                                : mintStatus.type === 'error'
                                                ? 'bg-red-50 text-red-800 border border-red-100'
                                                : 'bg-blue-50 text-blue-800 border border-blue-100'
                                        }`}>
                                            <p>{mintStatus.message}</p>
                                            {mintStatus.txHash && (
                                                <p className="font-mono text-[10px] break-all mt-1">
                                                    <a 
                                                        href={`https://sepolia.etherscan.io/tx/${mintStatus.txHash}`}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="underline"
                                                    >
                                                        查看交易: {mintStatus.txHash.substring(0, 10)}...
                                                    </a>
                                                </p>
                                            )}
                                        </div>
                                    )}
                                </motion.div>
                            )}

                            {/* Error Details */}
                            {initialVerificationStatus === 'error' && (
                                <motion.div
                                    initial={{ height: 0, opacity: 0 }}
                                    animate={{ height: 'auto', opacity: 1 }}
                                    className="text-xs bg-red-50 p-2 rounded border border-red-100 text-red-800"
                                >
                                    <p>Verification Failed. Please try again.</p>
                                </motion.div>
                            )}

                            {/* Twitter Item */}
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div className="flex items-center gap-3">
                                    <LucideIcon name="Twitter" size={18} />
                                    <span className="text-sm">X (Twitter)</span>
                                </div>
                                {twitterStatus === 'success' ? (
                                     <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded flex items-center gap-1">
                                        <LucideIcon name="Check" size={10} /> Verified
                                     </span>
                                ) : (
                                    <button
                                        onClick={onTwitterConnect}
                                        disabled={twitterStatus === 'loading'}
                                        className="text-xs bg-black text-white px-3 py-1.5 rounded hover:bg-gray-800 transition-colors"
                                    >
                                        {twitterStatus === 'loading' ? 'Verifying...' : 'Connect'}
                                    </button>
                                )}
                            </div>
                            {twitterStatus === 'success' && (
                                <motion.div
                                    initial={{ height: 0, opacity: 0 }}
                                    animate={{ height: 'auto', opacity: 1 }}
                                    className="space-y-2"
                                >
                                    <div className="text-[10px] bg-green-50 p-2 rounded text-green-800 font-mono break-all">
                                        Proof: {twitterProof?.proofId}
                                    </div>
                                    {account && (
                                        <button
                                            onClick={() => mintCredential(twitterProof, 1)}
                                            disabled={isMinting}
                                            className="w-full text-xs bg-accent text-white px-3 py-2 rounded hover:bg-accent-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                        >
                                            {isMinting ? (
                                                <>
                                                    <div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                    <span>上链中...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <LucideIcon name="Upload" size={12} />
                                                    <span>上链铸造凭证</span>
                                                </>
                                            )}
                                        </button>
                                    )}
                                    {!account && (
                                        <div className="text-xs text-gray-500 text-center py-1">
                                            连接钱包后可上链
                                        </div>
                                    )}
                                    {mintStatus && mintStatus.type !== 'pending' && (
                                        <div className={`text-xs p-2 rounded ${
                                            mintStatus.type === 'success' 
                                                ? 'bg-green-50 text-green-800 border border-green-100' 
                                                : 'bg-red-50 text-red-800 border border-red-100'
                                        }`}>
                                            <p>{mintStatus.message}</p>
                                            {mintStatus.txHash && (
                                                <p className="font-mono text-[10px] break-all mt-1">
                                                    <a 
                                                        href={`https://sepolia.etherscan.io/tx/${mintStatus.txHash}`}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="underline"
                                                    >
                                                        查看交易: {mintStatus.txHash.substring(0, 10)}...
                                                    </a>
                                                </p>
                                            )}
                                        </div>
                                    )}
                                </motion.div>
                            )}

                            <div className="flex items-center justify-between p-3 border border-dashed border-gray-300 rounded-lg text-gray-400">
                                <div className="flex items-center gap-3">
                                    <LucideIcon name="Plus" size={18} />
                                    <span className="text-sm">Add Source</span>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
        };

        return (
            <>
                <ProgressModal
                    isOpen={showProgressModal}
                    onClose={() => {
                        setShowProgressModal(false);
                    }}
                    steps={progressSteps}
                    currentStep={currentProgressStep}
                />
                <div className="pt-32 pb-20 px-6 max-w-7xl mx-auto">
                    <div className="text-center max-w-2xl mx-auto mb-16">
                        <h2 className="text-4xl font-bold mb-4">Unlock the value of Web2 data.</h2>
                        <p className="text-text-muted">Bridge the gap between off-chain reputation and on-chain utility.</p>
                    </div>

                <div className="grid grid-cols-1 lg:grid-cols-12 gap-12">
                    {/* Tabs Navigation (Left) */}
                    <div className="lg:col-span-4 flex flex-col gap-2">
                        {Object.keys(tabContent).map((key) => (
                            <div
                                key={key}
                                onClick={() => setActiveTab(key)}
                                className={`p-6 rounded-2xl cursor-pointer transition-all duration-300 border ${
                                    activeTab === key
                                        ? 'bg-white border-gray-200 shadow-sm'
                                        : 'bg-transparent border-transparent hover:bg-white/50'
                                }`}
                            >
                                <h3 className={`font-semibold text-lg mb-1 ${activeTab === key ? 'text-accent' : 'text-text'}`}>
                                    {key.charAt(0).toUpperCase() + key.slice(1)}
                                </h3>
                                <p className="text-sm text-text-muted leading-relaxed">
                                    {activeTab === key ? tabContent[key].desc : ""}
                                </p>
                            </div>
                        ))}
                    </div>

                    {/* Visual Mockup (Right) */}
                    <div className="lg:col-span-8">
                        <div className="bg-[#F0F2F5] p-8 rounded-3xl h-[500px] flex items-center justify-center relative overflow-hidden">
                            <motion.div
                                key={activeTab}
                                initial={{ opacity: 0, scale: 0.95 }}
                                animate={{ opacity: 1, scale: 1 }}
                                transition={{ duration: 0.4 }}
                                className="w-full max-w-md"
                            >
                                {tabContent[activeTab].mockup}
                            </motion.div>
                        </div>
                    </div>
                </div>
            </div>
            </>
        );
    };

    // --- Page: Developers ---

    const DevelopersPage = () => {
        return (
            <div className="pt-32 pb-20 px-6 max-w-7xl mx-auto">
                {/* Integration Section */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start mb-24">
                    <div className="sticky top-32">
                        <h2 className="text-4xl font-bold mb-6">Import. Verify. Mint.</h2>
                        <p className="text-text-muted text-lg mb-8">
                            Use our Rust SDK to build custom data parsers.
                            Define verification logic in standard Rust, and we handle the ZK circuit compilation.
                        </p>
                        <div className="flex flex-col gap-4">
                            <div className="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                                <div className="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-accent">1</div>
                                <span className="font-medium">Install Rust SDK</span>
                            </div>
                            <div className="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                                <div className="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-accent">2</div>
                                <span className="font-medium">Write Parser Logic</span>
                            </div>
                            <div className="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                                <div className="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-accent">3</div>
                                <span className="font-medium">Deploy to GhostLink Network</span>
                            </div>
                        </div>
                    </div>

                    {/* Code Editor */}
                    <div className="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden font-mono text-sm">
                        <div className="bg-gray-50 border-b border-gray-200 px-4 py-3 flex items-center gap-2">
                            <div className="flex gap-1.5">
                                <div className="w-3 h-3 rounded-full bg-gray-300"></div>
                                <div className="w-3 h-3 rounded-full bg-gray-300"></div>
                                <div className="w-3 h-3 rounded-full bg-gray-300"></div>
                            </div>
                            <span className="ml-4 text-xs text-gray-500">main.rs</span>
                        </div>
                        <div className="p-6 overflow-x-auto text-gray-800 leading-relaxed">
                            <div><span className="text-purple-600">use</span> ghostlink_sdk::prelude::*;</div>
                            <br/>
                            <div><span className="text-blue-600">fn</span> <span className="text-yellow-600">main</span>() &#123;</div>
                            <div className="pl-4"><span className="text-gray-400">// Read data from host</span></div>
                            <div className="pl-4"><span className="text-purple-600">let</span> input: <span className="text-yellow-600">String</span> = env::<span className="text-blue-600">read</span>();</div>
                            <br/>
                            <div className="pl-4"><span className="text-gray-400">// Verify JSON structure</span></div>
                            <div className="pl-4"><span className="text-purple-600">let</span> data: <span className="text-yellow-600">PayPalData</span> = serde_json::<span className="text-blue-600">from_str</span>(&input).unwrap();</div>
                            <br/>
                            <div className="pl-4"><span className="text-purple-600">if</span> data.balance &gt; <span className="text-blue-600">1000.0</span> &#123;</div>
                            <div className="pl-8">env::<span className="text-blue-600">commit</span>(&quot;<span className="text-green-600">SOLVENT</span>&quot;);</div>
                            <div className="pl-4">&#125;</div>
                            <div>&#125;</div>
                        </div>
                    </div>
                </div>

                {/* Marketplace */}
                <div>
                    <h3 className="text-2xl font-bold mb-8">Parser Marketplace</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                        {[
                            { name: 'GitHub', status: 'Live', color: 'bg-green-100 text-green-700' },
                            { name: 'Twitter', status: 'Live', color: 'bg-green-100 text-green-700' },
                            { name: 'Alipay', status: 'In Progress', color: 'bg-yellow-100 text-yellow-700' },
                            { name: 'Steam', status: 'Live', color: 'bg-green-100 text-green-700' },
                        ].map((item) => (
                            <div key={item.name} className="bg-white p-6 rounded-xl border border-gray-100 flex flex-col items-center gap-3 hover:shadow-md transition-shadow">
                                <div className="w-12 h-12 bg-gray-50 rounded-full flex items-center justify-center">
                                    <LucideIcon name={item.name === 'GitHub' ? 'Github' : item.name === 'Twitter' ? 'Twitter' : 'Globe'} size={24} />
                                </div>
                                <span className="font-semibold">{item.name}</span>
                                <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${item.color}`}>
                                        {item.status}
                                    </span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    };

    // --- Page: Company ---

    const CompanyPage = () => {
        return (
            <div className="pt-32 pb-20 px-6 max-w-7xl mx-auto">
                {/* Manifesto */}
                <section className="text-center py-20 mb-20">
                    <h1 className="text-5xl md:text-8xl font-bold tracking-tight text-text mb-8">
                        Data is Property.
                    </h1>
                    <p className="text-xl md:text-2xl text-text-muted max-w-3xl mx-auto font-light">
                        We believe that in the digital age, privacy is not about secrecy, but about <span className="text-accent">control</span>.
                        GhostLink builds the bridge for true data ownership.
                    </p>
                </section>

                {/* Roadmap */}
                <section className="max-w-2xl mx-auto">
                    <h3 className="text-xl font-bold mb-12 text-center">Master Plan</h3>
                    <div className="relative border-l-2 border-gray-100 ml-6 md:ml-0 space-y-16 pl-8 md:pl-12">
                        {[
                            { date: 'Q1 2026', title: 'MVP Launch', desc: 'GitHub Passport & Basic SDK release.', active: true },
                            { date: 'Q2 2026', title: 'SDK for dApps', desc: 'Plug-and-play components for React & Vue.', active: false },
                            { date: 'Q3 2026', title: 'Data Staking Economy', desc: 'Earn yield by verifying your own data.', active: false },
                        ].map((item, index) => (
                            <div key={index} className="relative group">
                                <div className={`absolute -left-[41px] md:-left-[57px] top-1 w-4 h-4 rounded-full border-4 border-white ${
                                    item.active ? 'bg-accent shadow-[0_0_0_4px_rgba(59,130,246,0.1)]' : 'bg-gray-200'
                                }`}></div>
                                <span className="text-sm font-mono text-accent mb-1 block">{item.date}</span>
                                <h4 className="text-xl font-bold mb-2">{item.title}</h4>
                                <p className="text-text-muted">{item.desc}</p>
                            </div>
                        ))}
                    </div>
                </section>
            </div>
        );
    };

    // --- Main App Controller ---

    const App = () => {
        const [activeTab, setActiveTab] = useState('home');
        const [verificationStatus, setVerificationStatus] = useState('idle');
        const [userData, setUserData] = useState(null);
        const [zkProof, setZkProof] = useState(null);

        // Twitter State
        const [twitterStatus, setTwitterStatus] = useState('idle');
        const [twitterUser, setTwitterUser] = useState(null);
        const [twitterProof, setTwitterProof] = useState(null);

        // Wallet State
        const { account, signer, connectWallet } = useWallet();

        // Handle Popup Logic & Message Listener
        useEffect(() => {
            // 1. If we are the popup (child window)
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            if (code && window.opener) {
                // Send code to parent
                window.opener.postMessage({
                    type: state === 'twitter' ? 'TWITTER_AUTH_CODE' : 'GITHUB_AUTH_CODE',
                    code: code
                }, window.location.origin);
                // Close self
                window.close();
                return;
            }

            // 2. If we are the main window (parent)
            const handleMessage = (event) => {
                if (event.origin !== window.location.origin) return;

                if (event.data.type === 'GITHUB_AUTH_CODE') {
                    handleGithubCallback(event.data.code);
                } else if (event.data.type === 'TWITTER_AUTH_CODE') {
                    handleTwitterCallback(event.data.code);
                }
            };

            window.addEventListener('message', handleMessage);
            return () => window.removeEventListener('message', handleMessage);
        }, []);

        const handleGithubCallback = (code) => {
            setActiveTab('solutions');
            setVerificationStatus('loading');
            fetch('http://localhost:8080/api/v1/auth/github/callback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    console.error("Auth error:", data.error);
                    setVerificationStatus('error');
                } else {
                    setUserData(data.user);
                    setZkProof(data.zkProof);
                    setVerificationStatus('success');
                }
            })
            .catch(err => {
                console.error("Network error:", err);
                setVerificationStatus('error');
            });
        };

        const handleTwitterCallback = (code) => {
            setActiveTab('solutions');
            setTwitterStatus('loading');

            // Retrieve PKCE verifier from session storage
            const codeVerifier = sessionStorage.getItem('twitter_code_verifier');

            fetch('http://localhost:8080/api/v1/auth/twitter/callback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    code,
                    redirectUri: REDIRECT_URI,
                    codeVerifier: codeVerifier
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) setTwitterStatus('error');
                else { setTwitterUser(data.user); setTwitterProof(data.zkProof); setTwitterStatus('success'); }
            })
            .catch(() => setTwitterStatus('error'));
        };

        const onGithubConnect = async () => {
             // 检查钱包连接
             if (!account) {
                 const shouldConnect = confirm('请先连接钱包才能进行验证和上链。\n\n是否现在连接钱包？');
                 if (shouldConnect) {
                     const connected = await connectWallet();
                     if (!connected) {
                         return; // 用户取消连接或连接失败
                     }
                 } else {
                     return; // 用户选择不连接
                 }
             }

             if (!GITHUB_CLIENT_ID) {
                 alert("【配置错误】\n请在 index.html 代码中填入您的 GitHub Client ID。\n\n请参考：GitHub Developer Settings > OAuth Apps");
                 return;
             }
             const authUrl = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=read:user`;
             // Open popup
             const width = 600;
             const height = 700;
             const left = (window.screen.width - width) / 2;
             const top = (window.screen.height - height) / 2;
             window.open(authUrl, 'GitHub Auth', `width=${width},height=${height},top=${top},left=${left}`);
        };

        const onTwitterConnect = async () => {
            // 检查钱包连接
            if (!account) {
                const shouldConnect = confirm('请先连接钱包才能进行验证和上链。\n\n是否现在连接钱包？');
                if (shouldConnect) {
                    const connected = await connectWallet();
                    if (!connected) {
                        return; // 用户取消连接或连接失败
                    }
                } else {
                    return; // 用户选择不连接
                }
            }

            if (!TWITTER_CLIENT_ID) { alert("Please set TWITTER_CLIENT_ID"); return; }

            // Twitter OAuth 2.0 PKCE Flow
            // Simple random string generator for demo
            const generateRandomString = (length) => {
                const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += charset.charAt(Math.floor(Math.random() * charset.length));
                }
                return result;
            };

            // Simple SHA256 for demo (in production use crypto.subtle)
            const sha256 = async (plain) => {
                const encoder = new TextEncoder();
                const data = encoder.encode(plain);
                return window.crypto.subtle.digest('SHA-256', data);
            };

            const base64urlencode = (a) => {
                return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            };

            const codeVerifier = generateRandomString(64);
            sessionStorage.setItem('twitter_code_verifier', codeVerifier);

            const codeChallengeBuffer = await sha256(codeVerifier);
            const codeChallenge = base64urlencode(codeChallengeBuffer);

            const authUrl = `https://twitter.com/i/oauth2/authorize?response_type=code&client_id=${TWITTER_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=users.read%20tweet.read&state=twitter&code_challenge=${codeChallenge}&code_challenge_method=S256`;

            window.open(authUrl, 'Twitter Auth', 'width=600,height=700');
        };

        const renderContent = () => {
            switch(activeTab) {
                case 'solutions':
                    return <SolutionsPage
                        initialVerificationStatus={verificationStatus}
                        initialUserData={userData}
                        initialZkProof={zkProof}
                        onGithubConnect={onGithubConnect}
                        twitterStatus={twitterStatus}
                        twitterUser={twitterUser}
                        twitterProof={twitterProof}
                        onTwitterConnect={onTwitterConnect}
                        walletAccount={account}
                        walletSigner={signer}
                    />;
                case 'developers': return <DevelopersPage />;
                case 'company': return <CompanyPage />;
                default: return <HomePage />;
            }
        };

        return (
            <div className="min-h-screen bg-bg">
                <Navbar activeTab={activeTab} setActiveTab={setActiveTab} />

                <AnimatePresence mode="wait">
                    <motion.main
                        key={activeTab}
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: -10 }}
                        transition={{ duration: 0.3 }}
                    >
                        {renderContent()}
                    </motion.main>
                </AnimatePresence>

                <Footer />
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>